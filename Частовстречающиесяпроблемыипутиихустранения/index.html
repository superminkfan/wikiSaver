<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Часто встречающиеся проблемы и пути их устранения</title>
    <style>
        body { display: flex; font-family: sans-serif; }
        nav { width: 250px; background: #f0f0f0; padding: 1em; height: 100vh; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        main { flex-grow: 1; padding: 2em; }
        .current > a { font-weight: bold; }
        a { text-decoration: none; color: #0366d6; }
        ul { list-style-type: none; padding-left: 1em; }
        li { margin-bottom: 0.5em; }
    </style>
</head>
<body>
    <nav><ul><li class="current"><a href="index.html">Часто встречающиеся проблемы и пути их устранения</a></li></ul></nav>
    <main><h1>Часто встречающиеся проблемы и пути их устранения</h1><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup class=""> <col class=""/> <col class=""/> </colgroup><tbody class=""><tr class=""><th class="confluenceTh"><span style="color: rgb(0,0,0);">Для кого</span></th><td class="confluenceTd"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="642201fd-4b93-419b-b3f3-88f07d91b43c">Сопровождение L2, команды разработки клиента</span></span></td></tr><tr class=""><th class="confluenceTh"><span style="color: rgb(0,0,0);">Зачем</span></th><td class="confluenceTd"><span style="color: rgb(0,0,0);">Перечислены часто встречающиеся проблемы и способы их решения</span></td></tr></tbody></table></div><h2 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблемыиихрешения"><span style="color: rgb(0,0,0);">Проблемы и их решения</span></h2><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Лишниеузлывтопологии"><span style="color: rgb(0,0,0);">Лишние узлы в топологии</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">Возможные проблемы:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">В топологии есть узлы, которых там быть не должно.</span></li><li>Запущен новый кластер, в котором версия<span style="color: rgb(0,0,0);"> </span><span style="color: rgb(0,0,0);">топологии (`topVer` в<span> </span><span>log-файле</span>) отличается от `1`.</span></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Причина"><span style="color: rgb(0,0,0);">Причина</span></h4><p><span style="color: rgb(0,0,0);">При конфигурировании узла/узлов для Discovery SPI мог использоваться поисковый механизм<span> </span></span><span style="color: rgb(23,43,77);">Multicast</span><span style="color: rgb(0,0,0);">. П</span><span style="color: rgb(23,43,77);">ример такой конфигурации:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: xml; gutter: false; theme: Confluence" data-theme="Confluence">&lt;property name="ipFinder"&gt;
                &lt;bean class="org.apache.ignite.spi.discovery.tcp.ipfinder.multicast.TcpDiscoveryMulticastIpFinder"&gt;
                    &lt;property name="multicastGroup" value="228.10.10.157"/&gt;
                &lt;/bean&gt;
            &lt;/property&gt;</pre>
</div></div><p><span style="color: rgb(0,0,0);">Чтобы проверить количество узлов в топологии, используйте один из способов:</span></p><ul style=""><li><p><span style="color: rgb(0,0,0);">Heartbeat-сообщение в log-файле `<code>ignite.log`</code>, в котором записывается количество узлов (`<code>hosts`</code>). Пример heartbeat-сообщения:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">Cluster [hosts=6, CPUs=9, servers=1, clients=5, topVer=10, minorTopVer=0]</pre>
</div></div></li><li><p><span style="color: rgb(0,0,0);">Команда `<code>--baseline` </code>с помощью консоли `control.sh`<code>. К</code>оманда вернет `<code>consistency id`</code><span> </span>узлов топологии, по которым можно обнаружить лишний узел.</span></p></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение"><span style="color: rgb(0,0,0);">Решение</span></h4><p><span style="color: rgb(0,0,0);">Настройте класс `TcpDiscoveryVmIpFinder` в конфигурационном файле DataGrid. `TcpDiscoveryVmIpFinder` — статический IP Finder, в его конфигурации указывается набор хостов и портов, которые проверяются при поиске узлов данного кластера.</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: xml; gutter: false; theme: Confluence" data-theme="Confluence">&lt;bean class="org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder"&gt;
    &lt;property name="addresses"&gt;
        &lt;list&gt;
            &lt;value&gt;127.0.0.1:47500..47509&lt;/value&gt;
        &lt;/list&gt;
    &lt;/property&gt;
&lt;/bean&gt;</pre>
</div></div><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Долгийзапускпервогоузлавтопологии"><span style="color: rgb(0,0,0);"> <strong>Долгий запуск первого узла в топологии</strong> </span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.1"><span style="color: rgb(0,0,0);"> <strong>Проблема</strong> </span></h4><p><span style="color: rgb(0,0,0);">Запуск первого узла занимает значительное время, при этом последующие узлы запускаются гораздо быстрее. </span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Причина.1"><span style="color: rgb(0,0,0);">Причина</span></h4><p style=""><span style="color: rgb(0,0,0);">Большое количество адресов и портов в конфигурации Discovery SPI. </span></p><p style=""><span style="color: rgb(0,0,0);">DataGrid сканирует все заданные в конфигурации порты. При включенной защите от сканирования портов может не приходить сообщение `Connection refused`. В этом случае проверка порта будет занимать все время, которое задано в значении тайм-аута `IgniteConfiguration.failureDetectionTimeout` (по умолчанию 10 секунд).</span></p><p style=""><span style="color: rgb(0,0,0);">Например, если в конфигурации 3 адреса и 10 портов на каждый из них, время запуска займет 5 минут (3 адреса \* 10 портов \* 10 секунд):</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: xml; gutter: false; theme: Confluence" data-theme="Confluence">&lt;bean class="org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder"&gt;
    &lt;property name="addresses"&gt;
        &lt;list&gt;
            &lt;value&gt;ignite1.local.net:47500..47509&lt;/value&gt;
            &lt;value&gt;ignite2.local.net:47500..47509&lt;/value&gt;
            &lt;value&gt;ignite3.local.net:47500..47509&lt;/value&gt;
        &lt;/list&gt;
    &lt;/property&gt;
&lt;/bean&gt;</pre>
</div></div><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.1"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="fc11f87b-a08f-4ade-ac8a-f26ad798a78a">Решение</span></span></h4><p style=""><span style="color: rgb(0,0,0);">Чтобы решить проблему:</span></p><ol style=""><li><span style="color: rgb(0,0,0);">Не прописывайте лишние порты и адреса. Указывайте только те, которые используются на самом деле.</span></li><li><span style="color: rgb(0,0,0);">Во внутренней сети отключите защиту от сканирования портов.</span></li><li><span style="color: rgb(0,0,0);">Снизьте значение `failureDetectionTimeout`, чтобы процесс сканирования проходил быстрее.</span></li></ol><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-ПроблемыприиспользованииIPv6"><span style="color: rgb(0,0,0);">Проблемы при использовании IPv6</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.2"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="da2d10ff-70ab-4eb1-98bb-b2ed9d445a23">Проблема</span></span></h4><p style=""><span style="color: rgb(0,0,0);">Возможные проблемы:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">Различные сетевые ошибки, которые связаны с невозможностью доставить сообщения и передать данные.</span></li><li><p>Сообщения в log-файле вида:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">Failed to connect to address

Node SEGMENTED

Failed to send message to remote node</pre>
</div></div></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Причина.2" style=""><span style="color: rgb(0,0,0);">Причина</span></h4><p style=""><span style="color: rgb(0,0,0);">По умолчанию решения DataGrid тестируются с использованием четвертой версии интернет-протокола (IPv4). При передаче данных с использованием шестой версии (IPv6) могут возникать ошибки, которые описаны выше. </span></p><p style=""><span style="color: rgb(0,0,0);">Причина возникновения таких<span> </span>ошибок — смешение<span> </span>окружений IPv4 и IPv6 при переходе с четвертой версии интернет-протокола на шестую.</span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.2" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Для решения конфликта между версиями установите значение `<code>true`</code> для параметра `<code>-Djava.net.preferIPv4Stack`</code> в конфигурационном файле `<code>Ignite-SE-15.0.0/config/jvm.opts`</code>.</span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-УзелврежимеMaintenanceMode"><span style="color: rgb(0,0,0);"> <strong>Узел в режиме Maintenance Mode</strong> </span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.3"><span style="color: rgb(0,0,0);"> <strong><span class="inline-comment-marker" data-ref="2b8df1bc-ef31-46e9-848e-9050a091703e">Проблема</span></strong><span class="inline-comment-marker" data-ref="2b8df1bc-ef31-46e9-848e-9050a091703e"> </span></span></h4><p style=""><span style="color: rgb(0,0,0);">Возможные проблемы:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">Узел не входит в топологию.</span></li><li><p>В log-файле во время загрузки вместо обычной шапки вида:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">&gt;&gt;&gt; Ignite ver. 2.12.0-p7#20220526-sha1:543651d5886a61d93d7f3381d3bacc10dcee3c17
&gt;&gt;&gt; OS name: Linux 3.10.0-1160.59.1.el7.x86_64 amd64
&gt;&gt;&gt; CPU(s): 16
&gt;&gt;&gt; Heap: 15.0GB
&gt;&gt;&gt; VM name: 1532437@tvldd-pprb00615
&gt;&gt;&gt; Local node[ID=1A60DC51-1655-4527-96B6-2D1D27E033F8, order=2, clientMode=false]
&gt;&gt;&gt; Local node addresses:[hostname, /127.0.0.1]
&gt;&gt;&gt; Local ports: TCP:8080 TCP:10800 TCP:11211 TCP:47100 TCP:4750</pre>
</div></div><p><span style="letter-spacing: 0.0px;">появляется шапка вида:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">&gt;&gt;&gt; Ignite ver. 2.12.0-p7#20220526-sha1:543651d5886a61d93d7f3381d3bacc10dcee3c17
&gt;&gt;&gt; --------------------------------------------------------------------------
&gt;&gt;&gt; OS name: Linux 3.10.0-1160.59.1.el7.x86_64 amd64
&gt;&gt;&gt; CPU(s): -1
&gt;&gt;&gt; Heap: 0.1GB
&gt;&gt;&gt; VM name: 1963884@tvldd-pprb00614
&gt;&gt;&gt; Local node [ID=6D7810F8-C65A-42A8-AA78-35D4FDA29BD6, order=1, clientMode=false]
&gt;&gt;&gt; Local node addresses: [localhost/127.0.0.1]
&gt;&gt;&gt; Local ports: TCP:8080 TCP:10800 TCP:11211 TCP:47100</pre>
</div></div><p><span style="color: rgb(23,43,77);">также в log-файле появляется сообщение об ошибке:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">[INFO ][main][org.apache.ignite.internal.IgniteKernal] Node is being started in maintenance mode. Starting IsolatedDiscoverySpi instead of configured discovery SPI.</pre>
</div></div></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Причина.3"><span style="color: rgb(0,0,0);">Причина</span></h4><p style=""><span style="color: rgb(0,0,0);">Узел загрузился в режиме Maintenance Mode — он предназначен для обслуживания узлов кластера с включенной персистентностью. Когда узел находится в этом режиме, на нем можно выполнять разные команды через скрипты и подключаться через JMX, но в топологию он не входит. </span></p><p style=""><span style="color: rgb(0,0,0);">Возможные причины перехода в режим Maintenance:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">очистка поврежденных файлов PDS (Persistence Data Store);</span></li><li>дефрагментация Native Persistence.</li></ul><p style=""><span style="color: rgb(0,0,0);">Конкретная причина указывается в сообщении log-файла:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">[INFO ][main][org.apache.ignite.internal.maintenance.MaintenanceProcessor] Node requires maintenance, non-empty set of maintenance tasks is found: [*corrupted-cache-data-files-task*]</pre>
</div></div><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.3" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><h5 id="id-Частовстречающиесяпроблемыипутиихустранения-ОчисткаповрежденныхфайловPDS" style=""><span style="color: rgb(0,0,0);">Очистка поврежденных<span> </span></span><span style="color: rgb(0,0,0);">файлов<span> </span></span><span style="color: rgb(0,0,0);">PDS</span></h5><p style=""><span style="color: rgb(0,0,0);">Возможный сценарий:</span></p><ol style=""><li><span style="color: rgb(0,0,0);">Узел падает в процессе Checkpointing, пока<span> </span>WAL-архив отключен<span> </span>для одного или нескольких кешей.</span></li><li>При следующем перезапуске узел обнаруживает, что файлы данных кеша могут быть повреждены, поэтому создает соответствующий Maintenance Task и отключается.</li><li>Во время следующего перезапуска узел переходит в Maintenance Mode и ожидает от пользователя решения проблемы.</li></ol><p style=""><span style="color: rgb(0,0,0);">В управляемых средах (например, Kubernetes) это означает, что узел не перезапустится автоматически и пользователь сможет найти возможные поврежденные файлы и удалить их. Когда файлы удаляются вручную, пользователь также удаляет Maintenance Task из регистра и перезапускает узел. В результате узел запускается в нормальном режиме и присоединяется к кластеру.</span></p><h5 id="id-Частовстречающиесяпроблемыипутиихустранения-ДефрагментацияNativePersistence" style=""><span style="color: rgb(0,0,0);">Дефрагментация Native Persistence</span></h5><p style=""><span style="color: rgb(0,0,0);">Возможный сценарий:</span></p><ol style=""><li><span style="color: rgb(0,0,0);">Пользователь с помощью скрипта `control.sh` или запросов других API создает Maintenance Task для дефрагментации Native Persistence на узле или определенных кешах.</span></li><li>Пользователь перезапускает узел. Он входит в режим Maintenance, находит Maintenance Task по дефрагментации и начинает выполнение задачи.</li><li>Когда дефрагментация завершается, Maintenance Task автоматически удаляется. При следующем перезапуске узел присоединяется к топологии.</li></ol><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблемысмаршалингомилисериализацией">Проблемы с маршалингом или сериализацией</h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.4"><span class="inline-comment-marker" data-ref="f3be6089-1425-48d5-9c5b-724eec119702">Проблема</span></h4><p><span style="color: rgb(23,43,77);">Сообщения в log-файле одного из видов:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">Some classes in query configuration cannot be written in binary format...</pre>
</div></div><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">Class FooBar cannot be serialized using BinaryMarshaller</pre>
</div></div><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.4"><span class="inline-comment-marker" data-ref="18fed199-07ba-443e-9407-17c4087f8530">Решение</span></h4><p style="">При взаимодействии продуктового кода с кодом DataGrid происходит сериализация. Это процесс, при котором продуктовый код преобразуется в формат, пригодный для хранения или передачи. Подробнее о сериализации написано в разделе [«Термины и определения»](<u><span>..</span></u><span class="">/</span><u><span>../glossary/md/</span></u><u>glossary.md</u>).</p><p style="">При записи данных в память для дальнейшего использования DataGrid сериализует объекты с помощью трех механизмов:</p><ul style=""><li>`JDK Marshaller` — обычная Java-сериализация.</li><li>`Optimized Marshaller` — оптимизированная Java-сериализация, при которой используются те же механизмы, что и<span> </span>в случае `JDK Marshaller`. Этот механизм обеспечивает обратную совместимость с Ignite 1.9.</li><li>`Binary Marshaller` — сериализация, которая создана специально для Apache Ignite и используется в DataGrid по умолчанию. Это наиболее быстрый механизм, который позволяет избегать дополнительной сериализации и десериализации, а также работать с объектом напрямую в бинарном формате.</li></ul><p style="">Проблемы с сериализацией классов могут возникать при использовании пользовательской реализации методов `readObject()` и `writeObject()` с помощью интерфейса `Externalizable`. В этом случае невозможна сериализация с помощью механизма `Binary Marshaller` по умолчанию, так как он сериализует объекты с помощью обычной записи полей и простых методов. В случае пользовательской сериализации DataGrid переключится на механизм `Optimized Marshaller` — это может привести к падению производительности.</p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Тайм-аутызаписинаклиентскихузлах"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="cfefaffe-9a23-49b0-b672-b817e0629dcf">Тайм-ауты записи на клиентских узлах</span></span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.5"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="68466e84-f9e7-4e52-81e9-7435e458c879">Проблема</span></span></h4><p style=""><span style="color: rgb(0,0,0);">Возможные проблемы:</span></p><ul style=""><li><p><span style="color: rgb(0,0,0);">При подключении<span> </span>клиентских узлов и попытке записи на них `<code>TcpCommunicationSpi`</code><span> </span>перестает работать по тайм-аутам:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">021-11-17 17:23:40:275 [WARN ] [org.apache.ignite.spi.communication.tcp.TcpCommunicationSpi] [grid-timeout-worker-#118%DPL_GRID%DplGridNodeName%] - Handshake timed out (will stop attempts to perform the handshake) [node=5b89fd66-11e5-4775-900a-64a1f2fb32f6, connTimeoutStrategy=ExponentialBackoffTimeoutStrategy [maxTimeout=600000, totalTimeout=30000, startNanos=1625306659621898, currTimeout=600000], err=Operation timed out [timeoutStrategy= ExponentialBackoffTimeoutStrategy [maxTimeout=600000, totalTimeout=30000, startNanos=1625306659621898, currTimeout=600000]], addr=/192.168.122.1:47100, failureDetectionTimeoutEnabled=true, timeout=0]</pre>
</div></div></li><li><p><span style="color: rgb(0,0,0);">В log-файлах сервера при наличии данной проблемы отображается много попыток входящих соединений:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">2021-11-17 17:24:29.141 [INFO ][grid-nio-worker-tcp-comm-10-#129%TcpCommunicationSpi%][org.apache.ignite.spi.communication.tcp.TcpCommunicationSpi] Accepted incoming communication connection [locAddr=/192.168.122.1:47100, rmtAddr=/192.168.122.1:42776]</pre>
</div></div></li></ul><p><span style="color: rgb(0,0,0);"> <code class="language-text">
</code> </span></p><p style=""><span style="color: rgb(0,0,0);">В целях диагностики обратите внимание на:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">IP-адрес, по которому происходит `time out handshake`;</span></li><li><span style="color: rgb(0,0,0);">IP-адрес, с которым запущен кластер.</span></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Причина.4"><span style="color: rgb(0,0,0);">Причина</span></h4><p style=""><span style="color: rgb(0,0,0);">Проблема появляется, когда:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">в операционной системе настроено несколько сетевых интерфейсов;</span></li><li><p><span style="color: rgb(0,0,0);"><span>`</span></span><code>TcpCommunicationSpi`</code><span style="color: rgb(0,0,0);"><span> </span>запускается в интерфейсе, отличающемся от того, на котором работает кластер:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">2021-11-17 00:00:10.362 [INFO ][grid-timeout-worker-#118][org.apache.ignite.internal.IgniteKernal]
Metrics for local node (to disable set 'metricsLogFrequency' to 0)
    ^-- Node [id=7eace3d5, uptime=1 day, 05:29:46.136]
    ^-- Cluster [hosts=32, CPUs=1792, servers=32, clients=9, topVer=53, minorTopVer=0]
    ^-- Network [addrs=[10.127.119.237, 127.0.0.1, 192.168.122.1], discoPort=47500, commPort=47100]
    ^-- CPU [CPUs=56, curLoad=0.03%, avgLoad=0.05%, GC=0%]
    ^-- Heap [used=10953MB, free=65.49%, comm=31744MB]
    ^-- Off-heap memory [used=132MB, free=99.98%, allocated=592071MB]
    ^-- Page memory [pages=33435]
    ^--   sysMemPlc region [type=internal, persistence=true, lazyAlloc=false,
      ...  initCfg=40MB, maxCfg=100MB, usedRam=0MB, freeRam=99.99%, allocRam=99MB, allocTotal=0MB]
    ^--   default region [type=default, persistence=true, lazyAlloc=true,
      ...  initCfg=256MB, maxCfg=591872MB, usedRam=130MB, freeRam=99.98%, allocRam=591871MB, allocTotal=129MB]
    ^--   metastoreMemPlc region [type=internal, persistence=true, lazyAlloc=false,
      ...  initCfg=40MB, maxCfg=100MB, usedRam=2MB, freeRam=97.99%, allocRam=0MB, allocTotal=2MB]
    ^--   TxLog region [type=internal, persistence=true, lazyAlloc=false,
      ...  initCfg=40MB, maxCfg=100MB, usedRam=0MB, freeRam=100%, allocRam=99MB, allocTotal=0MB]
    ^--   volatileDsMemPlc region [type=user, persistence=false, lazyAlloc=true,
      ...  initCfg=40MB, maxCfg=100MB, usedRam=0MB, freeRam=100%, allocRam=0MB]
    ^-- Ignite persistence [used=131MB]
    ^-- Outbound messages queue [size=0]
    ^-- Public thread pool [active=0, idle=0, qSize=0]
    ^-- System thread pool [active=0, idle=7, qSize=0]</pre>
</div></div></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.5"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="3426b970-c5ee-4486-9eea-5bf68e41b3cc">Решение</span></span></h4><p><span style="color: rgb(0,0,0);">Укажите в bean `</span><code style="">TcpCommunicationSpi`</code><span style="color: rgb(0,0,0);"> свойство с локальным IP-адресом, на котором запущен кластер (`</span><code style="">TcpDiscoveryVmIpFinder`</code><span style="color: rgb(0,0,0);">):</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: xml; gutter: false; theme: Confluence" data-theme="Confluence">&lt;property name="localAddress" value="1.2.3.4"/&gt;</pre>
</div></div><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-ДолгиетранзакциииLRT"><span style="color: rgb(0,0,0);">Долгие транзакции и LRT</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.6"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="fd190ab0-c778-4855-98cb-68e75f2ba3f6">Проблема</span></span></h4><p style=""><span style="color: rgb(0,0,0);">Возможные проблемы:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">Сработала метрика `LRT<span> </span><code>Found long running transaction NEW`</code><span> </span>в Grafana.</span></li><li><p>В log-файле `<code>ignite.log`</code><span style="color: rgb(0,0,0);"><span> </span>есть сообщения вида:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence"> [2021-10-06 11:41:53,530][WARN ][sys-#206%client%][root] First 10 long running transactions [total=10]
[2021-10-06 11:41:53,530][WARN ][sys-#206%client%][root] &gt;&gt;&gt; Transaction [startTime=11:41:52.961, curTime=11:41:53.518, systemTime=0, userTime=557, tx=GridNearTxLocal [mappings=IgniteTxMappingsImpl [], nearLocallyMapped=false, colocatedLocallyMapped=false, needCheckBackup=null, hasRemoteLocks=false, trackTimeout=false, systemTime=0, systemStartTime=0, prepareStartTime=0, prepareTime=0, commitOrRollbackStartTime=0, commitOrRollbackTime=0, lb=null, mvccOp=null, qryId=-1, crdVer=0, thread=async-tx-with-delay-#240%testscope%, mappings=IgniteTxMappingsImpl [], super=GridDhtTxLocalAdapter [nearOnOriginatingNode=false, span=o.a.i.i.processors.tracing.NoopSpan@60d3a365, nearNodes=KeySetView [], dhtNodes=KeySetView [], explicitLock=false, super=IgniteTxLocalAdapter [completedBase=null, sndTransformedVals=false, depEnabled=false, txState=IgniteTxStateImpl [activeCacheIds=[], recovery=null, mvccEnabled=null, mvccCachingCacheIds=[], txMap=EmptySet []], super=IgniteTxAdapter [xidVer=GridCacheVersion [topVer=244989714, order=1633509712519, nodeOrder=3], writeVer=null, implicit=false, loc=true, threadId=264, startTime=1633509712961, nodeId=390487f0-99c2-4890-992c-c9c3ac93d505, isolation=REPEATABLE_READ, concurrency=PESSIMISTIC, timeout=0, sysInvalidate=false, sys=false, plc=2, commitVer=null, finalizing=NONE, invalidParts=null, state=ACTIVE, timedOut=false, topVer=AffinityTopologyVersion [topVer=-1, minorTopVer=0], mvccSnapshot=null, skipCompletedVers=false, parentTx=null, duration=557ms, onePhaseCommit=false], size=0]]]]
...</pre>
</div></div></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.6"><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Некоторые события кластера запускают процесс обмена данными между узлами и их ребалансировку, чтобы обеспечить равномерное распределение данных по всему кластеру. Примеры таких событий — изменение топологии при подключении нового или отключении существующего узла, создание новых кешей или SQL-таблиц.</span></p><p style=""><span style="color: rgb(0,0,0);">При возникновении подобных событий в DataGrid может увеличиться порог времени проведения транзакций (по умолчанию 60 секунд). Проблема часто связана с появлением LRT — длительных транзакций, которые долго выполняются в кластере. Незавершенные транзакции препятствуют обмену данными, так как они блокируют операции кластера, например процесс подключения нового узла.</span></p><p style=""><span style="color: rgb(0,0,0);">Для решения проблемы проанализируйте содержимое log-файла, в котором присутствуют сообщения вида `</span>Found long running transaction NEW`. Возможные причины увеличения длительности транзакции:</p><ul style=""><li><span style="color: rgb(0,0,0);">Длительная работа прикладного кода. Об этой проблеме свидетельствует наличие транзакции в активном статусе (`</span>status=active`).</li><li><span style="color: rgb(0,0,0);">Неисправное состояние кластера, при котором транзакции перестали выполняться, например при отказе дисков.</span></li></ul><p style=""><span style="color: rgb(0,0,0);">При первом сообщении о появлении LRT в log-файле серверного узла выведется дамп потока, который запустил LRT на узле-координаторе транзакции. Часто этот узел является клиентским, то есть дамп потока транзакции также будет получен с клиентского узла. Дамп показывает тип выполняемой операции (бизнес-операция или взаимодействие с DataGrid). Признаки, которые присутствуют в дампах транзакций и свидетельствуют о наличии задержек:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">атрибуты `</span>TransactionProxyImpl.commit`, `TransactionProxyImpl.rollback` и `TransactionProxyImpl.prepare` свидетельствуют о задержках работы сети или GC-задержках (очистка мусора);</li><li><span style="color: rgb(0,0,0);">бизнес-коды, кеш-операции и другие параметры промежуточного состояния свидетельствуют о задержках в работе прикладного кода или о низких тайм-аутах транзакций.</span></li></ul><p style=""><span style="color: rgb(0,0,0);">Пример записи в log-файле:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">2022-07-06 05:31:08.093 [WARN ][sys-#112111][org.apache.ignite.internal.diagnostic] Dumping the near node thread that started transaction [xidVer=GridCacheVersion [topVer=267985566, order=1658822904791, nodeOrder=29, dataCenterId=0], nodeId=b1076c6d-e26d-44ff-bd30-af41845a42ed]
Stack trace of the transaction owner thread:
Thread [name="se-53", id=1353, state=WAITING, blockCnt=1, waitCnt=1788]
Lock [object=java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@a19d495, ownerName=null, ownerId=-1]
at sun.misc.Unsafe.park(Native Method)
at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
at java.util.concurrent.ArrayBlockingQueue.take(ArrayBlockingQueue.java:403)
at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
at java.lang.Thread.run(Thread.java:748)</pre>
</div></div><p style=""><span style="color: rgb(0,0,0);">LRT-транзакции часто возникают в результате следующих причин:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">повышенная загрузка узлов кластера;</span></li><li><span style="color: rgb(0,0,0);">наличие сетевых проблем, которые приводят к деградации вычислений;</span></li><li><span style="color: rgb(0,0,0);">системные проблемы — длительные GC-паузы на узлах, неоптимальный код, падение узлов кластера.</span></li></ul><p style=""><span style="color: rgb(0,0,0);">Чтобы настроить время срабатывания для вывода сообщений о наличии LTR-транзакций, воспользуйтесь JVM-опцией `</span>IGNITE_LONG_OPERATIONS_DUMP_TIMEOUT`. По умолчанию время вывода сообщений — 1 секунда.</p><p style=""><span style="color: rgb(0,0,0);">Чтобы установить максимальное время для длительных транзакций, используйте метод `</span>TransactionConfiguration.setTxTimeoutOnPartitionMapExchange(...)`<span style="color: rgb(0,0,0);">. Когда сработал тайм-аут, происходит откат всех незавершенных транзакций, после этого процесс обмена данными в кластере продолжается.</span></p><p style=""><span style="color: rgb(0,0,0);">Пример XML-файла для конфигурации времени тайм-аута:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: xml; gutter: false; theme: Confluence" data-theme="Confluence">&lt;bean class="org.apache.ignite.configuration.IgniteConfiguration"&gt;

    &lt;property name="transactionConfiguration"&gt;
        &lt;bean class="org.apache.ignite.configuration.TransactionConfiguration"&gt;
            &lt;!--Установите таймаут на 20 секунд.--&gt;
            &lt;property name="TxTimeoutOnPartitionMapExchange" value="20000"/&gt;
        &lt;/bean&gt;
    &lt;/property&gt;

&lt;/bean&gt;</pre>
</div></div><p><span style="color: rgb(0,0,0);"><code class="language-xml">
</code></span></p><p style=""><span style="color: rgb(0,0,0);">Чек-лист вопросов для анализа LRT-транзакций:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">В чем причина возникновения LRT?</span></li><li><span style="color: rgb(0,0,0);">Каким способом можно восстановить LRT — автоматически или вручную?</span></li><li><span style="color: rgb(0,0,0);">Что нужно сделать, чтобы снизить вероятность повторения сбоя в будущем?</span></li><li><span style="color: rgb(0,0,0);">Как LRT-транзакция повлияла на данные и дальнейшую работу?</span></li></ul><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-ДолгийPME"><span style="color: rgb(0,0,0);">Долгий PME</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.7"><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">PME занимает продолжительное время.</span></p><p style=""><span style="color: rgb(0,0,0);">PME (Partition Map Exchange) — процесс обмена информацией о партициях между узлами кластера. Его цель — установить актуальное состояние партиций для всех узлов кластера.</span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Причина.5"><span style="color: rgb(0,0,0);">Причина</span></h4><p style=""><span style="color: rgb(0,0,0);">Продолжительность PME зависит от количества партиций и<span> </span><span style="color: rgb(23,43,77);">длительности транзакций, которые должны завершиться перед началом процесса обмена.<span> </span></span></span><span style="color: rgb(0,0,0);">Чем меньше длительность PME, тем лучше.</span></p><p style=""><span style="color: rgb(0,0,0);">К симптомам относится срабатывание метрик по LRT, например `<code>Found Long Running Transactions NEW`</code>.</span></p><p style=""><span style="color: rgb(0,0,0);">Симптомы вызваны следующими проблемами:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">создание транзакций без тайм-аутов или с большими тайм-аутами;</span></li><li><span style="color: rgb(0,0,0);">наличие дефектов.</span></li></ul><p style=""><span style="color: rgb(0,0,0);">Есть вероятность, что транзакция никогда не будет завершена. Например, если пользователь запустил `<code>PESSIMISTIC`-</code>транзакции и выполнил `<code>cache put`</code>, который вызывает блокировку и настройку версии топологии транзакций. Для этого случая вводится `<code>timeout`</code> транзакции на PME. Если транзакция не может завершиться в рамках указанного<span> `</span><code>timeout`</code>, она принудительно отменится<span> </span>перед началом PME.</span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.7"><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Установите время в `setTxTimeoutOnPartitionMapExchange(long txTimeoutOnPartitionMapExchange)`. Если на момент начала PME транзакция не завершится, начнется отсчет этого тайм-аута. Когда он истечет, произойдет откат транзакции. </span></p><p style=""><span style="color: rgb(0,0,0);">Если тайм-ауты для транзакций не настроили должным образом, есть большая вероятность возникновения «повисших» транзакций. Их придется искать вручную и останавливать с помощью скрипта `control.sh`.</span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-ПоломкаH2-индексов"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="836b2c7b-1c62-4554-8e35-45c7ac060d06">Поломка H2-индексов</span></span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.8"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="4f45c16b-5e64-43d0-8fcd-97da30a91e97">Проблема</span></span></h4><p><span style="color: rgb(0,0,0);">Узлы завершают работу с ошибками вида `<code>Critical system error detected. Will be handled accordingly to configured handler`</code>. Поломка индексов выявляется в результате выполнения команды `<code>control.sh` `--cache validate_indexes &lt;optional arguments&gt;`</code>. </span></p><p>В log-файле появятся сообщения об ошибке. О поломке индексов свидетельствует сообщение `CorruptedTreeException: B+Tree is corrupted`:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">2021-11-22 17:33:43.466 [ERROR][sys-stripe-9-#10][] Critical system error detected. Will be handled accordingly to configured handler [hnd=StopNodeOrHaltFailureHandler [tryStop=false, timeout=0, super=AbstractFailureHandler [ignoredFailureTy
pes=UnmodifiableSet [SYSTEM_WORKER_BLOCKED, SYSTEM_CRITICAL_OPERATION_TIMEOUT]]], failureCtx=FailureContext [type=CRITICAL_ERROR, err=class o.a.i.i.processors.cache.persistence.tree.CorruptedTreeException: B+Tree is corrupted [pages(groupId,
pageId)=[IgniteBiTuple [val1=544320549, val2=844420635174666]], cacheId=-227153373, cacheName=APPLY_ERROR_V1, indexName=_key_PK, msg=Runtime failure on row: Row@4118366a[ key: BinaryObject [idHash=974233043, hash=1604362618], val: Data hidd
en due to IGNITE_TO_STRING_INCLUDE_SENSITIVE flag. ][ data hidden, data hidden, data hidden, data hidden, data hidden, data hidden, data hidden, data hidden, data hidden, data hidden, data hidden, data hidden, data hidden, data hidden ]]]]
org.apache.ignite.internal.processors.cache.persistence.tree.CorruptedTreeException: B+Tree is corrupted [pages(groupId, pageId)=[IgniteBiTuple [val1=544320549, val2=844420635174666]], cacheId=-227153373, cacheName=APPLY_ERROR_V1, indexName=
_key_PK, msg=Runtime failure on row: Row@4118366a[ key: BinaryObject [idHash=974233043, hash=1604362618], val: Data hidden due to IGNITE_TO_STRING_INCLUDE_SENSITIVE flag. ][ data hidden, data hidden, data hidden, data hidden, data hidden, da
ta hidden, data hidden, data hidden, data hidden, data hidden, data hidden, data hidden, data hidden, data hidden ]]</pre>
</div></div><p style="margin-left: 40.0px;"><span style="color: rgb(0,0,0);"> <code class="language-text">
</code> </span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.8"><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Перестройте индексы:</span></p><ol style=""><li><span style="color: rgb(0,0,0);">Остановите проблемные узлы.</span></li><li><span style="color: rgb(0,0,0);">Удалите проблемный файл `<code>index.bin`</code>.</span></li><li><span style="color: rgb(0,0,0);">Запустите узлы.</span></li><li><span style="color: rgb(0,0,0);">Выполните процесс перестройки всех индексов с помощью команды `<code>control.sh` z--cache indexes_force_rebuild --node-ids nodeId1,...nodeIdN|--all-nodes --cache-names cacheName1,...cacheNameN|--group-names groupName1,...groupNameN`</code>.</span></li><li><span style="color: rgb(0,0,0);">Дождитесь завершения процесса перестройки индексов.</span></li></ol><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Неравномернаязагрузкаузлов"><span style="color: rgb(0,0,0);">Неравномерная загрузка узлов</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.9"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="16fee88e-7a6c-4a14-8b46-e2245d9e60e2">Проблема</span></span></h4><p style=""><span style="color: rgb(0,0,0);">Неравномерное распределение данных по узлам кластера и неравномерная нагрузка на них.</span></p><p style=""><span style="color: rgb(0,0,0);">Некорректное распределение данных и ошибки кода могут приводить к скоплению запросов на одном узле. Из-за этого возникает неравномерная загрузка на остальные узлы:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">на уровне аппаратных и/или физических ресурсов, к которым относятся CPU, SSD, RAM, LAN, аппаратные ресурсы узлов кластера;</span></li><li><span style="color: rgb(0,0,0);">на уровне неаппаратных ресурсов, к которым относятся системные потоки кластера (thread pools), все виды памяти в операционной системе, партиции и так далее.</span></li></ul><p style=""><span style="color: rgb(0,0,0);">Каждый вид ресурсов может утилизироваться преимущественно на одном из узлов. Из-за этого кластер не сможет отрабатывать запросы со скоростью, которая требуется по SLA, или развалится.</span></p><p style=""><span style="color: rgb(0,0,0);">Мониторинг симптомов возможен с помощью сбора фактуры `<code>ignite.log`</code>, метрик DataGrid и операционной системы.</span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Причина.6" style=""><span style="color: rgb(0,0,0);">Причина</span></h4><p style=""><span style="color: rgb(0,0,0);">Возможные причины проблемы:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">некорректная конфигурация, например указан только один IP-адрес;</span></li><li><span style="color: rgb(0,0,0);">ошибки в коде, из-за которых данные и запросы направляются на один узел.</span></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.9" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Для решения проблемы установите причину концентрации данных. </span></p><p style=""><span style="color: rgb(0,0,0);">Если причина в некорректной конфигурации, настройте ее. Если проблема в коде, найдите ошибки и решите проблему с ключами, разнесением данных по узлам и партициям.</span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Медленнаяработадиска"><span style="color: rgb(0,0,0);">Медленная работа диска</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.10"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="6b7dd136-6b57-4db1-af72-2db209422085">Проблема</span></span></h4><p style=""><span style="color: rgb(0,0,0);">Возможные причины проблемы:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">увеличение продолжительности процесса Checkpointing;</span></li><li>checkpoints spikes на графике;</li><li>кластер «тормозит».</li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Причина.7" style=""><span style="color: rgb(0,0,0);">Причина</span></h4><p style=""><span style="color: rgb(0,0,0);">Вероятная причина проблемы — несбалансированность пропускной способности памяти и диска. В целях диагностики проверьте метрику, которая показывает количество сбрасываемых страниц (`LastCheckpointTotalPagesNumber`). Если она коррелирует с увеличением длительности Checkpointing, с большой вероятностью проблемы нет, а время увеличилось за счет роста нагрузки на диск.</span></p><p style=""><span style="color: rgb(0,0,0);">Если метрика не коррелирует с длительностью Checkpointing, проанализируйте содержимое<span> `</span><code>ignite.log`</code>, `<code>dmesg` и</code> `<code>messages`</code> — возможно, диск утилизирован или возникла проблема на уровне операционной системы или железа. Для решения проблемы передайте службе поддержки DataGrid содержимое файлов `<code>ignite`</code>, `<code>dmesg` и</code> `<code>messages`</code>.</span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.10" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Решение зависит от результатов, которые будут получены после изучения log-файла на наличие сообщений уровня `<code>ERROR` и </code>`<code>WARN`</code>.</span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Взаимоблокировка(deadlock)"><span style="color: rgb(0,0,0);">Взаимоблокировка (deadlock)</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.11"><span style="color: rgb(0,0,0);">Проблема</span></h4><p style="">Возможные проблемы:</p><ul style=""><li><span style="color: rgb(0,0,0);">Замедление бизнес-операций.</span></li><li><p>Завершение транзакций сообщениями вида:<br/>- на серверных узлах:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">[ERROR][grid-timeout-worker-#118][org.apache.ignite.internal.processors.cache.distributed.dht.colocated.GridDhtColocatedCache] &lt;tw.transactions&gt; Failed to acquire lock for request: GridNearLockRequest [topVer=AffinityTopologyVersion [topVer=418, minorTopVer=0], miniId=1, dhtVers=GridCacheVersion[] [null], subjId=088f0b3b-8b8c-4d41-ab0c-73cd0d5af2f8, taskNameHash=0, createTtl=-1, accessTtl=-1, flags=5, txLbl=null, filter=null, super=GridDistributedLockRequest [nodeId=088f0b3b-8b8c-4d41-ab0c-73cd0d5af2f8, nearXidVer=GridCacheVersion [topVer=245981357, order=1637825079145, nodeOrder=400], threadId=8689, futId=334a5c5cc71-0864976c-edcc-4d9e-bb9a-92b2b91a2bd2, timeout=30000, isInTx=true, isInvalidate=false, isRead=true, isolation=REPEATABLE_READ, retVals=[true], txSize=0, flags=2, keysCnt=1, super=GridDistributedBaseMessage [ver=GridCacheVersion [topVer=245981357, order=1637825079145, nodeOrder=400], committedVers=null, rolledbackVers=null, cnt=0, super=GridCacheIdMessage [cacheId=92902112, super=GridCacheMessage [msgId=155993, depInfo=null, lastAffChangedTopVer=AffinityTopologyVersion [topVer=24, minorTopVer=71], err=null, skipPrepare=false]]]]]
org.apache.ignite.internal.transactions.IgniteTxTimeoutCheckedException: Failed to acquire lock within provided timeout for transaction [timeout=30000, tx=GridDhtTxLocal[xid=8776bf55d71-00000000-0ea9-60ad-0000-000000000004, xidVersion=GridCacheVersion [topVer=245981357, order=1637825079160, nodeOrder=4], nearXidVersion=GridCacheVersion [topVer=245981357, order=1637825079145, nodeOrder=400], concurrency=PESSIMISTIC, isolation=REPEATABLE_READ, state=MARKED_ROLLBACK, invalidate=false, rollbackOnly=true, nodeId=63a1650c-7291-44be-a5b7-3be796c4ad6f, timeout=30000, startTime=1635424056538, duration=30007]]
at org.apache.ignite.internal.processors.cache.transactions.IgniteTxLocalAdapter$PostLockClosure1.apply(IgniteTxLocalAdapter.java:1798) ~[ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.processors.cache.transactions.IgniteTxLocalAdapter$PostLockClosure1.apply(IgniteTxLocalAdapter.java:1746) ~[ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.util.future.GridEmbeddedFuture$2.applyx(GridEmbeddedFuture.java:86) ~[ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.util.future.GridEmbeddedFuture$AsyncListener1.apply(GridEmbeddedFuture.java:292) [ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.util.future.GridEmbeddedFuture$AsyncListener1.apply(GridEmbeddedFuture.java:285) [ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.util.future.GridFutureAdapter.notifyListener(GridFutureAdapter.java:399) [ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.util.future.GridFutureAdapter.unblock(GridFutureAdapter.java:347) [ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.util.future.GridFutureAdapter.unblockAll(GridFutureAdapter.java:335) [ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.util.future.GridFutureAdapter.onDone(GridFutureAdapter.java:511) [ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.processors.cache.GridCacheCompoundIdentityFuture.onDone(GridCacheCompoundIdentityFuture.java:56) [ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.util.future.GridFutureAdapter.onDone(GridFutureAdapter.java:490) [ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.processors.cache.distributed.dht.GridDhtLockFuture.onComplete(GridDhtLockFuture.java:802) [ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.processors.cache.distributed.dht.GridDhtLockFuture.access$900(GridDhtLockFuture.java:93) [ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.processors.cache.distributed.dht.GridDhtLockFuture$LockTimeoutObject.onTimeout(GridDhtLockFuture.java:1202) [ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.processors.timeout.GridTimeoutProcessor$TimeoutWorker.body(GridTimeoutProcessor.java:234) [ignite-core-2.10.0-p1.jar:2.10.0-p1]
at org.apache.ignite.internal.util.worker.GridWorker.run(GridWorker.java:120) [ignite-core-2.10.0-p1.jar:2.10.0-p1]
at java.lang.Thread.run(Thread.java:748) [?:1.8.0_301]</pre>
</div></div><p><span style="color: rgb(0,0,0);letter-spacing: 0.0px;">- на инициаторе транзакции:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">Caused by: javax.cache.CacheException: class org.apache.ignite.transactions.TransactionTimeoutException: Failed to acquire lock within provided timeout for transaction [timeout=30000, tx=GridNearTxLocal[xid=f3c4b265d71-00000000-0ea9-60ad-0000-00000000019a, xidVersion=GridCacheVersion [topVer=245981357, order=1637828217919, nodeOrder=410], nearXidVersion=GridCacheVersion [topVer=245981357, order=1637828217919, nodeOrder=410], concurrency=PESSIMISTIC, isolation=REPEATABLE_READ, state=MARKED_ROLLBACK, invalidate=false, rollbackOnly=true, nodeId=68ca22f4-38be-4027-8c81-94b0ea81559e, timeout=30000, startTime=1635430164207, duration=30016, label=null]]
   at org.apache.ignite.internal.processors.cache.GridCacheUtils.convertToCacheException(GridCacheUtils.java:1263)
   at org.apache.ignite.internal.processors.cache.IgniteCacheProxyImpl.cacheException(IgniteCacheProxyImpl.java:2083)
   at org.apache.ignite.internal.processors.cache.IgniteCacheProxyImpl.get(IgniteCacheProxyImpl.java:1110)
   at org.apache.ignite.internal.processors.cache.GatewayProtectedCacheProxy.get(GatewayProtectedCacheProxy.java:676)
   at com.sbt.processing.data.ignite.IgniteWriter.writeIdentifiableInternal(IgniteWriter.java:95)
   at com.sbt.processing.data.ignite.IgniteWriter.appendIdentifiable(IgniteWriter.java:74)
   ... 17 more
   Caused by: class org.apache.ignite.transactions.TransactionTimeoutException: Failed to acquire lock within provided timeout for transaction [timeout=30000, tx=GridNearTxLocal[xid=f3c4b265d71-00000000-0ea9-60ad-0000-00000000019a, xidVersion=GridCacheVersion [topVer=245981357, order=1637828217919, nodeOrder=410], nearXidVersion=GridCacheVersion [topVer=245981357, order=1637828217919, nodeOrder=410], concurrency=PESSIMISTIC, isolation=REPEATABLE_READ, state=MARKED_ROLLBACK, invalidate=false, rollbackOnly=true, nodeId=68ca22f4-38be-4027-8c81-94b0ea81559e, timeout=30000, startTime=1635430164207, duration=30016, label=null]]
   at org.apache.ignite.internal.util.IgniteUtils$13.apply(IgniteUtils.java:987)
   at org.apache.ignite.internal.util.IgniteUtils$13.apply(IgniteUtils.java:984)
   ... 23 more
   Caused by: class org.apache.ignite.transactions.TransactionDeadlockException:
   Deadlock detected:
K1: TX1 holds lock, TX2 waits lock.
K2: TX2 holds lock, TX1 waits lock.
Transactions:
TX1 [txId=GridCacheVersion [topVer=245981357, order=1637828217886, nodeOrder=418], nodeId=1d0a56c0-cc47-4369-b9c5-c5fe1fffe7bf, threadId=1176]
TX2 [txId=GridCacheVersion [topVer=245981357, order=1637828217919, nodeOrder=410], nodeId=68ca22f4-38be-4027-8c81-94b0ea81559e, threadId=12957]
Keys:
K1 [key=d6oDXoRGCvEAAAF8x+CxoMaIDaIpVm6K, cache=tw.transactions_bundle]
K2 [key=d6oDXoRGCvEAAAF8x+CxoMaIDaIpVm6K, cache=tw.transactions]
    at org.apache.ignite.internal.processors.cache.distributed.dht.colocated.GridDhtColocatedLockFuture$LockTimeoutObject$1.apply(GridDhtColocatedLockFuture.java:1539)
    at org.apache.ignite.internal.processors.cache.distributed.dht.colocated.GridDhtColocatedLockFuture$LockTimeoutObject$1.apply(GridDhtColocatedLockFuture.java:1532)
    at org.apache.ignite.internal.util.future.GridFutureAdapter.notifyListener(GridFutureAdapter.java:399)
    at org.apache.ignite.internal.util.future.GridFutureAdapter.unblock(GridFutureAdapter.java:347)
    at org.apache.ignite.internal.util.future.GridFutureAdapter.unblockAll(GridFutureAdapter.java:335)
    at org.apache.ignite.internal.util.future.GridFutureAdapter.onDone(GridFutureAdapter.java:511)
    at org.apache.ignite.internal.util.future.GridFutureAdapter.onDone(GridFutureAdapter.java:490)
    at org.apache.ignite.internal.processors.cache.transactions.TxDeadlockDetection$TxDeadlockFuture.onDone(TxDeadlockDetection.java:538)
    at org.apache.ignite.internal.processors.cache.transactions.TxDeadlockDetection$TxDeadlockFuture.onDone(TxDeadlockDetection.java:163)
    at org.apache.ignite.internal.util.future.GridFutureAdapter.onDone(GridFutureAdapter.java:467)
    at org.apache.ignite.internal.processors.cache.transactions.TxDeadlockDetection$TxDeadlockFuture.detect(TxDeadlockDetection.java:314)
    at org.apache.ignite.internal.processors.cache.transactions.TxDeadlockDetection$TxDeadlockFuture.onResult(TxDeadlockDetection.java:514)
    at org.apache.ignite.internal.processors.cache.transactions.IgniteTxManager$DeadlockDetectionListener.onMessage(IgniteTxManager.java:3593)
    at org.apache.ignite.internal.managers.communication.GridIoManager.invokeListener(GridIoManager.java:1908)
    at org.apache.ignite.internal.managers.communication.GridIoManager.processRegularMessage0(GridIoManager.java:1529)
    at org.apache.ignite.internal.managers.communication.GridIoManager.access$5300(GridIoManager.java:242)
    at org.apache.ignite.internal.managers.communication.GridIoManager$9.execute(GridIoManager.java:1422)
    at org.apache.ignite.internal.managers.communication.TraceRunnable.run(TraceRunnable.java:55)
    at org.apache.ignite.internal.util.StripedExecutor$Stripe.body(StripedExecutor.java:569)
    at org.apache.ignite.internal.util.worker.GridWorker.run(GridWorker.java:120)
    ... 1 more</pre>
</div></div></li></ul><p><span style="color: rgb(0,0,0);"> <code class="language-text">
</code> </span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.11"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="55ac0d70-f4ae-42bf-8db9-1b1368488373">Решение</span></span></h4><p><span style="color: rgb(0,0,0);">По сообщению на инициаторе транзакции определите, на каком ключе произошла взаимоблокировка:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">K1 [key=d6oDXoRGCvEAAAF8x+CxoMaIDaIpVm6K, cache=tw.transactions_bundle]
K2 [key=d6oDXoRGCvEAAAF8x+CxoMaIDaIpVm6K, cache=tw.transactions]</pre>
</div></div><p><span style="color: rgb(0,0,0);"> <code class="language-text">
</code> </span></p><p><span style="color: rgb(0,0,0);">Обычно данную информацию нужно передать на анализ прикладным разработчикам, чтобы они смогли определить причины возникновения взаимоблокировки в коде. Если добавлен параметр `</span><code style="">-DIGNITE_TO_STRING_INCLUDE_SENSITIVE=false`</code><span style="color: rgb(0,0,0);">, значение ключей не будет попадать в log-файл и по сообщениям не получится узнать, на каких ключах произошла взаимоблокировка.</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">K1 [key=, cache=tw.transactions_bundle]
K2 [key=, cache=tw.transactions]</pre>
</div></div><p><span style="color: rgb(0,0,0);"> <code class="language-text">
</code> </span></p><p style=""><span style="color: rgb(0,0,0);">Обнаружение взаимоблокировок — многоэтапная процедура, для которой может понадобиться много итераций в зависимости от количества узлов в кластере, ключей и транзакций, которые участвуют в возможном deadlock.</span></p><p style=""><span style="color: rgb(0,0,0);">Инициатор обнаружения взаимоблокировки — узел, на котором транзакция началась, но была прервана с исключением `<code>TransactionTimeOutException`</code>. Этот узел будет исследовать, произошла ли взаимоблокировка: обмениваться запросами/ответами с другими удаленными узлами. Затем он подготовит отчет о взаимоблокировке с помощью `<code>TransactionDeadlockException`</code>. Каждое такое сообщение (запрос/ответ) — одна итерация.</span></p><p style=""><span style="color: rgb(0,0,0);">Для предсказуемого времени отката транзакции настройте максимальное количество итераций для процедуры обнаружения взаимоблокировки<code> — `Ignitesystemproperties.ignite_tx_deadlock_detection_max_iters`.</code> Если значение свойства — 0 и меньше, `<code>deadlock detection`</code> будет отключен (значение по умолчанию — 1000). `<code>Ignitesystemproperties.ignite_tx_deadlock_detection_timeout`</code> указывает время ожидания для обнаружения взаимоблокировки (по умолчанию 1 минута).</span></p><p style=""><span style="color: rgb(0,0,0);">Настроить другой тайм-аут можно с помощью опции</span><span style="color: rgb(0,0,0);"> `-<span style="color: rgb(23,43,77);">DIGNITE_TX_DEADLOCK_DETECTION_TIMEOUT=&lt;new_timeout&gt;`.</span></span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Незапускаетсяузел(общиерекомендации)" style=""><span style="color: rgb(0,0,0);">Не запускается узел (общие рекомендации)</span></h3><p style=""><span style="color: rgb(0,0,0);">Чтобы установить причины, проведите анализ log-файлов. Рекомендуется следующая последовательность анализа:</span></p><ol style=""><li><span style="color: rgb(0,0,0);">Просмотрите содержимое `<code>ignite.log`</code><span> </span>— в нем будет присутствовать сообщение о причине прерывания запуска. Если log-файл пустой или обрывается без сообщения об ошибке, перейдите к следующему пункту.</span></li><li><span style="color: rgb(0,0,0);">Проверьте содержимое `<code>err.out`</code> — в нем может присутствовать сообщение об ошибке.</span></li><li><span style="color: rgb(0,0,0);">Проверьте `<code>gc.log`</code><span> </span>и узнайте, запустилась ли JVM.<span> </span>Проверьте, не создался ли файл `crush<span> </span>dump`.</span></li><li><span style="color: rgb(0,0,0);">Изучите `<code>dmesg` и </code>`<code>messages`</code>.</span></li></ol><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Незапускаетсяклиентскийузел(Unabletoestablishsecureconnection)" style=""><span style="color: rgb(0,0,0);">Не запускается клиентский узел (Unable to establish secure connection)</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.12" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">Возможные проблемы:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">Не запускается клиентский узел.</span></li><li><p>В log-файле клиентского узла есть сообщение:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">10.06.2021 15:36:44,654 INFO  [stdout] (ServerService Thread Pool – 105) Caused by: org.apache.ignite.spi.IgniteSpiException: Unable to establish secure connection. Was remote cluster configured with SSL? [rmtAddr=/10.107.33.137:47500, errMsg="Received fatal alert: handshake_failure"]</pre>
</div></div></li></ul><p style="margin-left: 40.0px;"><span style="color: rgb(0,0,0);"> <code class="language-text">
</code> </span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.12"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="8967f355-d325-443e-b5b5-7fab33016514">Решение</span></span></h4><p><span style="color: rgb(0,0,0);">Убедитесь, что в XML- конфигурации клиентского и серверного узлов установлено одно и то же значение:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: xml; gutter: false; theme: Confluence" data-theme="Confluence">&lt;property name="protocols" value="#{systemProperties['https.protocols']}" /&gt;</pre>
</div></div><p><span style="color: rgb(0,0,0);"> <code class="language-xml">
</code> </span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Незапускаетсясерверныйузел(Failedtobindtoany[host:port]fromtherange)" style=""><span style="color: rgb(0,0,0);">Не запускается серверный узел (<code class="language-text">Failed to bind to any [host:port] from the range)</code></span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.13">Проблема</h4><p>Возможные проблемы:</p><ul style=""><li>Не запускается серверный узел.</li><li><p>В log-файле серверного узла есть сообщение:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">2021-07-02 15:35:07.381 [ERROR][main][org.apache.ignite.internal.IgniteKernal] Got exception while starting (will rollback startup routine).
org.apache.ignite.IgniteCheckedException: Failed to start processor: GridProcessorAdapter []
at org.apache.ignite.internal.IgniteKernal.startProcessor(IgniteKernal.java:1960) ~[ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.internal.IgniteKernal.start(IgniteKernal.java:1237) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.internal.IgnitionEx$IgniteNamedInstance.start0(IgnitionEx.java:2046) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.internal.IgnitionEx$IgniteNamedInstance.start(IgnitionEx.java:1698) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.internal.IgnitionEx.start0(IgnitionEx.java:1114) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.internal.IgnitionEx.startConfigurations(IgnitionEx.java:1032) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.internal.IgnitionEx.start(IgnitionEx.java:918) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.internal.IgnitionEx.start(IgnitionEx.java:817) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.internal.IgnitionEx.start(IgnitionEx.java:687) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.internal.IgnitionEx.start(IgnitionEx.java:656) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.Ignition.start(Ignition.java:353) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.startup.cmdline.CommandLineStartup.main(CommandLineStartup.java:300) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
Caused by: org.apache.ignite.IgniteCheckedException: Failed to start client connector processor.
at org.apache.ignite.internal.processors.odbc.ClientListenerProcessor.start(ClientListenerProcessor.java:215) ~[ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.internal.IgniteKernal.startProcessor(IgniteKernal.java:1957) ~[ignite-core-2.9.0-p8.jar:2.9.0-p8]
... 11 more
Caused by: org.apache.ignite.IgniteCheckedException: Failed to bind to any [host:port] from the range [host=0.0.0.0, portFrom=10800, portTo=10800, lastErr=class org.apache.ignite.IgniteCheckedException: Failed to initialize NIO selector.]
at org.apache.ignite.internal.processors.odbc.ClientListenerProcessor.start(ClientListenerProcessor.java:203) ~[ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.internal.IgniteKernal.startProcessor(IgniteKernal.java:1957) ~[ignite-core-2.9.0-p8.jar:2.9.0-p8]
... 11 more</pre>
</div></div></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.13"><span style="color: rgb(0,0,0);">Решение</span></h4><p><span style="color: rgb(0,0,0);">Проверьте, кем заняты порты из диапазона `portFrom` <span style="color: rgb(60,65,72);">–</span> `portTo`:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">netstat -anp | grep ПОРТ;</pre>
</div></div><p><span style="color: rgb(0,0,0);">С большой вероятностью диапазон занят клиентским узлом. Если это так, отключите клиентский узел и перезапустите серверный, который не удавалось запустить. Когда серверный узел подключится, запустите клиентский.</span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Незапускаетсяignite-provider" style=""><span style="color: rgb(0,0,0);">Не запускается ignite-provider</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.14" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">Возможные проблемы:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">Не запускается `ignite-provider 4.1.0` после обновления на WildFly (WF).</span></li><li><p>В `server.log` WildFly есть сообщение:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">Caused by: java.lang.ClassNotFoundException: org.apache.commons.lang.StringUtils from [Module "deployment.ignite-provider-ear-4.1.0.ear" from Service Module Loader] at org.jboss.modules.ModuleClassLoader.findClass(ModuleClassLoader.java:255) at org.jboss.modules.ConcurrentClassLoader.performLoadClassUnchecked(ConcurrentClassLoader.java:410) at org.jboss.modules.ConcurrentClassLoader.performLoadClass(ConcurrentClassLoader.java:398) at org.jboss.modules.ConcurrentClassLoader.loadClass(ConcurrentClassLoader.java:116) ... 37 common frames omitted</pre>
</div></div></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.14"><span style="color: rgb(0,0,0);">Решение</span></h4><p><span style="color: rgb(0,0,0);">Перезапустите WildFly (WF). Данная проблема возникает, если после обновления не перезапустить WF.</span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Превышениеколичестваоткрытыхфайловыхдескрипторов"><span style="color: rgb(0,0,0);">Превышение количества открытых файловых дескрипторов</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.15"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="80546115-756a-42f8-9147-fb652cf348a4">Проблема</span></span></h4><p style=""><span style="color: rgb(0,0,0);">Возможные проблемы:</span></p><ul style=""><li>Узел не запускается.</li><li>Узел упал во время работы.</li><li><p>В log-файле узла есть сообщение вида:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">Caused by: java.io.IOException: Too many open files
at java.base/sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)
at java.base/sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:533)
at java.base/sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:285)
at org.apache.ignite.internal.util.nio.GridNioServer$GridNioAcceptWorker.processSelectedKeys(GridNioServer.java:2998)
at org.apache.ignite.internal.util.nio.GridNioServer$GridNioAcceptWorker.accept(GridNioServer.java:2928)
... 3 more</pre>
</div></div></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.15"><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Для диагностики проверьте лимиты количества открытых файлов. Посмотреть полную информацию об открытых файлах можно с помощью команды `lsof`. Если большинство открытых файлов относится к пользователю Ignite, убедитесь, что максимальное количество файлов рассчитано корректно. </span></p><p style=""><span style="color: rgb(0,0,0);">Проверка файловых дескрипторов в</span><span style="color: rgb(0,0,0);"> разрезе пользователей (`user` — имя пользователя):</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">sudo lsof -u user | wc -l</pre>
</div></div><p style=""><span style="color: rgb(0,0,0);">Проверка дескрипторов по всей файловой системе — файлы `/proc/sys/fs/file-nr` и `/proc/sys/fs/file-max`. В файле `/proc/sys/fs/file-nr` указаны 3 значения:</span></p><ol style=""><li><span style="color: rgb(0,0,0);">Количество выделенных файловых дескрипторов.</span></li><li>Количество выделенных, но не используемых файловых дескрипторов.</li><li>Максимально возможное количество файловых дескрипторов (соответствует значению в файле `file-max`).</li></ol><p style=""><span style="color: rgb(0,0,0);">Если второе значение всегда равно нулю — это не ошибка. Это означает, что все выделенные дескрипторы используются (ранее дескрипторы могли динамически назначаться, но не освобождаться после использования).</span></p><p style=""><span style="color: rgb(0,0,0);">Установка лимитов в</span><span style="color: rgb(0,0,0);"> разрезе пользователей в файле `/etc/security/limits.conf` с помощью строки вида:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">&lt;domain&gt; &lt;type&gt; &lt;item&gt; &lt;value&gt;</pre>
</div></div><p style=""><span style="color: rgb(0,0,0);">Где:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">`domain` — пользователь;</span></li><li><span style="color: rgb(0,0,0);">`type` — тип ограничения (жесткое/мягкое);</span></li><li><span style="color: rgb(0,0,0);">`i</span><span style="color: rgb(0,0,0);">tem` — объект ограничения для пользователя (максимальный размер файла, максимальное количество процессов, максимальное количество логинов и так далее);</span></li><li><span style="color: rgb(0,0,0);">`value` — значение ограничения.</span></li></ul><p style=""><span style="color: rgb(0,0,0);">Установка лимитов по всей файловой системе в файле `/etc/sysctl.conf` с помощью добавления строки вида (`number` — лимит):</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">fs.file-max=number</pre>
</div></div><p><span style="color: rgb(0,0,0);"> </span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.16" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Увеличьте лимиты в случае необходимости и/или снизьте потребление.</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">quantity = (partition-number / server-number) + cache-groups</pre>
</div></div><p style=""><span style="color: rgb(0,0,0);">Где:</span></p><ul><li style=""><span style="color: rgb(0,0,0);">`quantity` — количество требуемых файловых дескрипторов;</span></li><li style=""><span style="color: rgb(0,0,0);">`partition-number` — число партиций (файлов), которые распределены в соответствии с affinity-функцией во всем <span style="color: rgb(23,43,77);">кластере DataGrid;</span></span></li><li style=""><span style="color: rgb(0,0,0);"><span style="color: rgb(23,43,77);">`server-number` — <span style="color: rgb(0,0,0);">количество серверов;</span></span></span></li><li style=""><span style="color: rgb(0,0,0);"><span style="color: rgb(23,43,77);"><span style="color: rgb(0,0,0);">`cache-groups` — количество партиций в реплицированных кеш-группах.</span></span></span></li></ul><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Росточередиstripedpool"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="6006bbb5-fc07-49ae-b793-6e7793f0a12c">Рост очереди striped pool</span></span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.16"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="6006bbb5-fc07-49ae-b793-6e7793f0a12c">Проблема</span></span></h4><p style=""><span style="color: rgb(0,0,0);">При резком росте нагрузки запросы (кеш-операции и транзакции) могут накапливаться в очереди `<code>striped pool executor`</code>. </span></p><p style=""><span style="color: rgb(0,0,0);">Если очередь обслуживается неуспешно, график метрики<span> `</span><code>IgniteStripedThreadPoolExecutor`</code><span> </span>может выглядеть как кривая с резким ростом и продолжительным линейным падением или как прямая с долгим линейным ростом. Такие виды графиков свидетельствуют о проблемах с обработкой очереди запросов. Они связаны с тем, что очередь запросов накапливается слишком быстро и отдельные операции не успевают<span> </span><span style="color: rgb(23,43,77);">обрабатываться</span>. Также о проблеме с накоплением очереди могут говорить сообщения о долгом выполнении запросов в log-файлах. Если очередь обслуживается успешно, на графике `<code>IgniteStripedThreadPoolExecutor`</code> будут наблюдаться узкие пики. Они демонстрируют резкие рост и спад.</span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.17" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Подобные проблемы вызваны неравномерным распределением данных и/или неверным распределением ключей по партициям. Например, если ключи попали в одну партицию, запросы тоже будут попадать в одну и ту же партицию. Из-за этого остальные кеш-операции и транзакции будут находиться в режиме ожидания и формировать очередь на выполнение в одном потоке.</span></p><p style=""><span style="color: rgb(0,0,0);">Для решения проблемы найдите медленно выполняющиеся транзакции и передайте информацию о проблеме для оптимизации прикладным разработчикам.</span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-ВысокаяутилизацияCPU"><span style="color: rgb(0,0,0);">Высокая утилизация CPU</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.17"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="aec3f7f2-6047-46d5-81a9-68130c3c375c">Проблема</span></span></h4><p style=""><span style="color: rgb(0,0,0);">Высокая утилизация CPU.</span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.18"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="aec3f7f2-6047-46d5-81a9-68130c3c375c">Решение</span></span></h4><p style=""><span style="color: rgb(0,0,0);">Для решения проблемы высокой утилизации CPU с помощью Java-процесса нужно знать идентификатор PID (process identifier) проблемного процесса. Выполните следующие шаги:</span></p><ol style=""><li><p><span style="color: rgb(0,0,0);">Получите потоки процесса по PID с помощью команды:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">ps aux -T | grep PID &gt; psaux.txt</pre>
</div></div><p style=""><span style="color: rgb(0,0,0);">В результате выполнения этой команды будет выведен список всех потоков процесса с утилизацией CPU по каждому из них. Чтобы понять, какой участок кода внутри JVM утилизировал CPU и в какой период времени, используйте атрибуты `<code>SPID`</code> и `<code>%CPU`</code>. Отсортируйте данные из столбца `<code>%CPU`</code> по убыванию.</span></p></li><li><p><span style="color: rgb(0,0,0);letter-spacing: 0.0px;">Соберите `</span><code style="color: rgb(0,0,0);letter-spacing: 0.0px;">thread dumps`</code><span style="color: rgb(0,0,0);letter-spacing: 0.0px;"> с помощью команды:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">jstack -l PID &gt; jstack.txt</pre>
</div></div><p style=""><span style="color: rgb(0,0,0);">Для дальнейшей работы используйте атрибуты `<code>SPID`</code>, представленные в шестнадцатеричной системе счисления в поле `<code>nid`</code>.</span></p></li><li><span style="color: rgb(0,0,0);">Сопоставьте атрибуты `<code>%CPU`</code> и `<code>SPID`</code>, которые получили на предыдущих двух шагах. Это сравнение поможет понять, какой участок кода внутри JVM утилизировал CPU и на какой период времени.</span></li></ol><p><br/></p><p><span style="color: rgb(0,0,0);"> <strong><span class="inline-comment-marker" data-ref="c56277d3-c326-4ae2-9116-d1206b3b80a4">Пример</span><span class="inline-comment-marker" data-ref="c56277d3-c326-4ae2-9116-d1206b3b80a4">:</span></strong></span></p><p style=""><span style="color: rgb(0,0,0);"> &gt; <strong>Примечание</strong></span></p><p style=""><span style="color: rgb(0,0,0);">&gt;</span></p><p style=""><span style="color: rgb(0,0,0);">&gt; В качестве примера используйется поток JVM с PID `<code>2350369`</code>.</span></p><ol style=""><li><p><span style="color: rgb(0,0,0);">Запросите потоки процесса:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">ps aux -T | grep 2350369 &gt; [psaux.txt]</pre>
</div></div></li><li><p><span style="color: rgb(0,0,0);">Соберите `</span><code style="text-align: left;">thread dumps`</code><span style="color: rgb(0,0,0);">:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">jstack -l 2350369 &gt; [jstack.txt]</pre>
</div></div><p style=""><span style="color: rgb(0,0,0);">В примере самые нагруженные по CPU потоки — `<code>738903`</code> и `<code>747596`</code>. В шестнадцатеричной системе они соответствуют `<code>b4657`</code> и `<code>b684C`</code> соответственно.</span></p></li><li><p style=""><span style="color: rgb(0,0,0);letter-spacing: 0.0px;">Найдите в `</span><code style="color: rgb(0,0,0);letter-spacing: 0.0px;">jstack`</code><span style="color: rgb(0,0,0);letter-spacing: 0.0px;"> </span><span style="color: rgb(0,0,0);letter-spacing: 0.0px;">потоки с идентификаторами (`nid`)</span><span style="color: rgb(0,0,0);letter-spacing: 0.0px;"> `</span><code style="color: rgb(0,0,0);letter-spacing: 0.0px;">b4657`</code><span style="color: rgb(0,0,0);letter-spacing: 0.0px;"> и `</span><code style="color: rgb(0,0,0);letter-spacing: 0.0px;">b684c`</code><span style="color: rgb(0,0,0);letter-spacing: 0.0px;">:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">"kafka-producer-network-thread | transport-lib-producer-[hostname]-[union-module]-[default]-[5ac8b7d4-b6c7-4506-bf4c-77a390e9ecad]" #99 daemon prio=5 os_prio=0 tid=0x00007f8e098ea000 nid=0xb4657 runnable [0x00007f8e05964000]
java.lang.Thread.State: RUNNABLE

"[union-module]-[com.sbt.core.commons.config_impl.PlatformPropertyLoaderImpl-pci-union-module-D-01.021.01------]-kafka-processor-thread-2" #622 prio=5 os_prio=0 tid=0x00007f8a98043000 nid=0xb684c runnable [0x00007ef40abe9000]
java.lang.Thread.State: RUNNABLE</pre>
</div></div></li></ol><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Падениесерверныхузлов(ошибкаUnknownconnectiondetectedвlog-файле)" style=""><span style="color: rgb(0,0,0);">Падение серверных узлов (ошибка Unknown connection detected в log-файле)</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.18" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p><span style="color: rgb(0,0,0);">Возможные проблемы:</span></p><ul><li style=""><p><span style="color: rgb(0,0,0);">Серверные узлы аварийно завершают работу со стек-трейсом вида:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence"> 2021-11-07 01:08:25.603 [ERROR][tcp-disco-srvr-[:47500]-#3-#57][] Critical system error detected. Will be handled accordingly to configured handler [hnd=StopNodeOrHaltFailureHandler [tryStop=false, timeout=0, super=AbstractFailureHandler [ignoredFailureTypes=UnmodifiableSet [SYSTEM_WORKER_BLOCKED, SYSTEM_CRITICAL_OPERATION_TIMEOUT]]], failureCtx=FailureContext [type=SYSTEM_WORKER_TERMINATION, err=java.net.SocketTimeoutException: Accept timed out]]
java.net.SocketTimeoutException: Accept timed out
at java.net.PlainSocketImpl.socketAccept(Native Method) ~[?:?]
at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:458) ~[?:?]
at java.net.ServerSocket.implAccept(ServerSocket.java:565) ~[?:?]
at java.net.ServerSocket.accept(ServerSocket.java:533) ~[?:?]
at org.apache.ignite.spi.discovery.tcp.ServerImpl$TcpServer.body(ServerImpl.java:6603) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.internal.util.worker.GridWorker.run(GridWorker.java:120) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.spi.discovery.tcp.ServerImpl$TcpServerThread.body(ServerImpl.java:6526) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
at org.apache.ignite.spi.IgniteSpiThread.run(IgniteSpiThread.java:58) [ignite-core-2.9.0-p8.jar:2.9.0-p8]
2021-11-07 01:08:25.609 [ERROR][tcp-disco-srvr-[:47500]-#3-#57][] JVM will be halted immediately due to the failure: [failureCtx=FailureContext [type=SYSTEM_WORKER_TERMINATION, err=java.net.SocketTimeoutException: Accept timed out]]</pre>
</div></div></li><li style=""><p style=""><span style="color: rgb(0,0,0);">Перед падением появляются предупреждения вида:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">Unknown connection detected (is some other software connecting to this Ignite port?) [rmtAddr=/&lt;rmtAddr&gt;:52082, locAddr=/&lt;localAddr&gt;:47100]</pre>
</div></div></li></ul><p style="margin-left: 40.0px;"><span style="color: rgb(0,0,0);"> <code class="language-text">
</code> </span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.19" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Источником попыток подключения в большинстве случаев может быть сканер безопасности.</span></p><p style=""><span style="color: rgb(0,0,0);">Дополнительная обработка `SocketTimeoutException` добавлена в DataGrid в версиях 4.2110.4 и 4.2120.0. Чтобы решить проблему, перейдите на одну из указанных версий.</span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-ОшибкаOutOfMemoryError(Unabletocreatenewnativethread)" style=""><span style="color: rgb(0,0,0);">Ошибка OutOfMemoryError (Unable to create new native thread)</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.19" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">Узел падает с ошибкой:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">OutOfMemoryError: unable to create new native thread</pre>
</div></div><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.20"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="8e83ac1b-760d-4572-a074-0ea7b268f3ac">Решение</span></span></h4><p style=""><span style="color: rgb(0,0,0);">`OutOfMemoryError` в данном случае говорит не о нехватке места в Java Heap или RAM, а о проблеме `OutOfResources`. У операционной системы недостаточно ресурсов для создания дополнительных потоков. Проблема редкая, так как обычно не требуется так много потоков. </span></p><p style=""><span style="color: rgb(0,0,0);">Количество потоков в операционной системе ограничено и отличается для разных систем. В качестве решения проблемы рассмотрите возможность переписать прикладной код таким образом, чтобы Callable- и Runnable-потоки создавались с помощью `Executor`, то есть чтобы был контроль количества создаваемых потоков.</span></p><p style=""><span style="color: rgb(0,0,0);">Если JVM запускается через `systemd`, найдите `service status` и проверьте `maxTasks (tasks = threads) per process limit`. </span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-ОшибкиприиспользованииNULLCipherSuites" style=""><span style="color: rgb(0,0,0);">Ошибки при использовании NULL Cipher Suites</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.20" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">Возможные проблемы:</span></p><ul style=""><li>Узел не присоединяется к топологии.</li><li><p>В log-файле есть сообщения вида:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">org.apache.ignite.IgniteException: Unable to establish secure connection. Was remote cluster configured with SSL? [rmtAddr=/127.0.0.1:47500, errMsg="No appropriate protocol (protocol is disabled or cipher suites are inappropriate)"]</pre>
</div></div></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.21" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">По умолчанию при использовании плагина<span> </span>безопасности и SSL шифрование не используется (в целях снижения нагрузки на кластер). Для этого используются NULL Cipher Suites, которые отключены в версиях JDK 8u201 и новее. При попытке использования шифров в версии Java с отключенными NULL Cipher Suites можно наблюдать описанную выше ошибку. </span></p><p style=""><span style="color: rgb(0,0,0);">Варианты решения проблемы:</span></p><ul><li><p><span style="color: rgb(0,0,0);">Исключите значения `NULL` из параметра `<code>jdk.tls.disabledAlgorithms`</code><span> </span>файла `<code>java.security`</code>. Для этого в файле `<code>$JAVA_HOME/jre/lib/security/java.security`</code><span> </span>(в версии 11 файл называется `<code>jdk-11.0.2.jdk/Contents/Home/conf/security/java.security`</code>) найдите строку:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">jdk.tls.disabledAlgorithms=SSLv3, RC4, DES, MD5withRSA, DH keySize &lt; 1024, \ 
EC keySize &lt; 224, 3DES_EDE_CBC, anon, NULL</pre>
</div></div><p><span style="color: rgb(0,0,0);letter-spacing: 0.0px;">И замените ее на строку:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">jdk.tls.disabledAlgorithms=SSLv3, RC4, DES, MD5withRSA, DH keySize &lt; 1024, \ 
EC keySize &lt; 224, 3DES_EDE_CBC, anon</pre>
</div></div><p><span style="color: rgb(0,0,0);letter-spacing: 0.0px;">Если не получается отредактировать файл `</span><code style="color: rgb(0,0,0);letter-spacing: 0.0px;">java.security`</code><span style="color: rgb(0,0,0);letter-spacing: 0.0px;">, скопируйте JDK в другую папку и измените `</span><code style="color: rgb(0,0,0);letter-spacing: 0.0px;">java.security`</code><span style="color: rgb(0,0,0);letter-spacing: 0.0px;"> там. Измененный файл можно скопировать и использовать в среде разработки.</span></p></li><li><p><span style="letter-spacing: 0.0px;color: rgb(0,0,0);">Создайте отдельный файл, например `</span><code style="letter-spacing: 0.0px;color: rgb(0,0,0);">disabledAlgorithms.properties`</code><span style="letter-spacing: 0.0px;color: rgb(0,0,0);">, и пропишите в нем:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">jdk.tls.disabledAlgorithms=SSLv3, RC4, DES, MD5withRSA, DH keySize &lt; 1024, EC keySize &lt; 224, 3DES_EDE_CBC, anon</pre>
</div></div></li><li><p><span style="color: rgb(23,43,77);">З</span><span style="color: rgb(0,0,0);">апустите Java с опцией `<code>java -Djava.security.properties=disabledAlgorithms.properties`</code>.</span></p></li></ul><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Ошибкиприпопыткеподключениясразныминастройкамиjdk.tls.disabledAlgorithms" style=""><span style="color: rgb(0,0,0);">Ошибки при попытке подключения с разными настройками jdk.tls.disabledAlgorithms</span></h3><p style=""><span style="color: rgb(0,0,0);">По умолчанию в настройках файла `</span>jdk.tls.disabledAlgorithms`<span style="color: rgb(0,0,0);"> указано значение `</span>NULL` — удалите его<span style="color: rgb(0,0,0);">. В случае, если на стороне сервера и клиента используются файлы `</span>jdk.tls.disabledAlgorithms`<span style="color: rgb(0,0,0);"> с разными настройками (с `</span>NULL`<span style="color: rgb(0,0,0);"> и без </span>него<span style="color: rgb(0,0,0);">), могут возникнуть ошибки:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">`<code>No appropriate protocol (protocol is disabled or cipher suites are inappropriate)`</code><span> </span>появляется, если сервер использует файл `<code>jdk.tls.disabledAlgorithms`</code><span> </span>без `<code>NULL`</code>, а клиент — файл с `<code>NULL`</code>. Для решения проблемы удалите значение `<code>NULL`</code><span> </span>в файле клиента.</span></li><li><span style="color: rgb(0,0,0);">`<code>Received fatal alert: handshake_failure`</code><span> </span>появляется, если сервер использует файл `<code>jdk.tls.disabledAlgorithms`</code><span> </span>с `<code>NULL`</code>, а клиент — файл без `<code>NULL`</code>. Для решения проблемы</span><span style="color: rgb(0,0,0);"><span> </span>удалите значение `<code>NULL`</code> в файле сервера.</span></li></ul><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-НекорреткныепризнакиEKUвсертификатах"><span style="color: rgb(0,0,0);">Некорреткные признаки EKU в сертификатах</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.21" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">Ошибки handshake SSL (`<code>javax.net.ssl.SSLHandshakeException`</code>): узел не может присоединиться к топологии.</span></p><p style=""><span style="color: rgb(0,0,0);">У толстого клиента отсутствие `<code>serverAuth`</code> при наличии `<code>clientAuth`</code> приводит к тому, что клиенты входят в топологию и через некоторое время выходят из нее из-за ошибки взаимодействия по `TcpCommunication`.</span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.22" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">EKU (Extended Key Usage) должны содержать оба признака: `<code>serverAuth`</code> и `<code>clientAuth`</code>.</span></p><p style=""><span style="color: rgb(0,0,0);">В плагине безопасности есть валидация параметров EKU. При неверных признаках узел будет завершать работу с одной из указанных ниже ошибок.</span></p><p><span style="color: rgb(0,0,0);">Пустой EKU:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence"> 2023-06-16 09:00:38.616 [ERROR][main][org.apache.ignite.internal.IgniteKernal] Got exception while starting (will rollback startup routine).
org.apache.ignite.plugin.security.SecurityException: The ExtendedKeyUsage extension of the local node certificate is not set. Make sure ExtendedKeyUsage contains both 'serverAuth' and 'clientAuth'.</pre>
</div></div><p><span style="color: rgb(0,0,0);">Не хватает какого-то признака в EKU:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence"> 2023-06-16 09:00:38.616 [ERROR][main][org.apache.ignite.internal.IgniteKernal] Got exception while starting (will rollback startup routine).
org.apache.ignite.plugin.security.SecurityException: The ExtendedKeyUsage extension of the local node certificate is not valid. Make sure ExtendedKeyUsage contains both 'serverAuth' and 'clientAuth' [expEku=[1.3.6.1.5.5.7.3.1, "1.3.6.1.5.5.7.3.2], certEku=[1.3.6.1.5.5.7.3.2]]</pre>
</div></div><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-ОшибкаUnacknowledgedmessagesqueuesizeoverflowвlog-файлахинизкаяскоростьопераций" style=""><span style="color: rgb(0,0,0);">Ошибка Unacknowledged messages queue size overflow в log-файлах и низкая скорость операций</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.22" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">При включенном SSL и/или плагине безопасности наблюдается снижение производительности и сообщения в log-файле вида:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">[2023-05-14T15:16:46,231][WARN ][grid-nio-worker-tcp-comm-3-#26%TcpCommunicationSpi%][TcpCommunicationSpi] Unacknowledged messages queue size overflow, will attempt to reconnect [remoteAddr=/&lt;ip-address:port&gt;, queueLimit=4096]</pre>
</div></div><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">[2023-05-14T15:16:47,233][ERROR][grid-nio-worker-tcp-comm-3-#26%TcpCommunicationSpi%][TcpCommunicationSpi] Failed to process selector key ... at org.apache.ignite.internal.util.nio.ssl.GridNioSslHandler.encrypt(GridNioSslHandler.java:393) ~[ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.nio.ssl.GridNioSslFilter.encrypt(GridNioSslFilter.java:337) ~[ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.nio.GridNioServer$DirectNioClientWorker.processWriteSsl(GridNioServer.java:1506) ~[ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.nio.GridNioServer$DirectNioClientWorker.processWrite(GridNioServer.java:1405) ~[ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.nio.GridNioServer$AbstractNioClientWorker.processSelectedKeysOptimized(GridNioServer.java:2529) [ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.nio.GridNioServer$AbstractNioClientWorker.bodyInternal(GridNioServer.java:2281) [ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.nio.GridNioServer$AbstractNioClientWorker.body(GridNioServer.java:1910) [ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.worker.GridWorker.run(GridWorker.java:125) [ignite-core-2.15.0.jar:2.15.0] at java.lang.Thread.run(Thread.java:834) [?:?] [2023-05-14T15:16:47,234][WARN ][grid-nio-worker-tcp-comm-3-#26%TcpCommunicationSpi%][TcpCommunicationSpi] Client disconnected abruptly due to network connection loss or because the connection was left open on application shutdown ... at org.apache.ignite.internal.util.nio.ssl.GridNioSslHandler.encrypt(GridNioSslHandler.java:393) ~[ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.nio.ssl.GridNioSslFilter.encrypt(GridNioSslFilter.java:337) ~[ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.nio.GridNioServer$DirectNioClientWorker.processWriteSsl(GridNioServer.java:1506) ~[ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.nio.GridNioServer$DirectNioClientWorker.processWrite(GridNioServer.java:1405) ~[ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.nio.GridNioServer$AbstractNioClientWorker.processSelectedKeysOptimized(GridNioServer.java:2529) [ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.nio.GridNioServer$AbstractNioClientWorker.bodyInternal(GridNioServer.java:2281) [ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.nio.GridNioServer$AbstractNioClientWorker.body(GridNioServer.java:1910) [ignite-core-2.15.0.jar:2.15.0] at org.apache.ignite.internal.util.worker.GridWorker.run(GridWorker.java:125) [ignite-core-2.15.0.jar:2.15.0] at java.lang.Thread.run(Thread.java:834) [?:?]</pre>
</div></div><p><br/></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.23" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">В потоке `<code>grid-nio-worker-tcp-comm-3-#26%TcpCommunicationSpi%`</code> сначала происходит превышение очереди неподтвержденных (unacknowledged) сообщений `<code>TcpCommunication`</code>, а затем принудительный разрыв соединения.</span></p><p style=""><span style="color: rgb(0,0,0);">Проблема возникает из-за роста очереди неподтвержденных сообщений `<code>TcpCommunication`</code> во время всплеска нагрузки, особенно при `<code>putAll`</code>. Оптимизируйте бизнес-нагрузку на кластер и/или выполните вертикальное и горизонтальное масштабирование кластера DataGrid.</span></p><p style=""><span style="color: rgb(0,0,0);">В качестве обходного решения можно увеличить размер очереди (по умолчанию 4096). Для этого укажите параметр `<code>TcpCommunicationSpi#unacknowledgedMessagesBufferSize`</code>. Может потребоваться установить его больше в несколько раз, например `<code>65535`</code>. Выбранное значение нужно тщательно проверить во время нагрузочного тестирования.</span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Потеряданныхвpersistence-кластерах" style=""><span style="color: rgb(0,0,0);">Потеря данных в persistence-кластерах</span></h3><p style=""><span style="color: rgb(0,0,0);">Потеря данных в кластере с режимом Native Persistence возможна при реализации сценария:</span></p><ol style=""><li><span style="color: rgb(0,0,0);">Запускается один узел.</span></li><li><span style="color: rgb(0,0,0);">Кластер активируется.</span></li><li><span style="color: rgb(0,0,0);">Запускается еще несколько узлов.</span></li><li><span style="color: rgb(0,0,0);">Останавливается первый узел.</span></li></ol><p style=""><span style="color: rgb(0,0,0);">Причина проблемы в данном случае — запуск узлов после активации кластера. Они находятся вне базовой топологии (baseline topology) и не хранят persistence-данные. Базовая топология определяется в момент первой активации кластера.</span></p><p style=""><span style="color: rgb(0,0,0);">Если узлы добавляются или выходят из кластера, их можно добавить в топологию или исключить из нее с помощью скрипта `control.sh`.</span></p><p><span style="color: rgb(0,0,0);">Проверка состояния топологии:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">control.sh --baseline</pre>
</div></div><p><span style="color: rgb(0,0,0);">Добавление узлов в топологию:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">control.sh --baseline add consistentId1,consistentId2,... [--yes]</pre>
</div></div><p><span style="color: rgb(0,0,0);">Удаление узлов из топологии:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">control.sh --baseline remove consistentId1,consistentId2,... [–yes]</pre>
</div></div><p><span style="color: rgb(0,0,0);">Настройка топологии с помощью списка узлов:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">control.sh --baseline set consistentId1,consistentId2,... [--yes]</pre>
</div></div><p style=""><span style="color: rgb(0,0,0);">Для решения проблемы потери данных в persistence-кластерах:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">активируйте кластер только после запуска всех серверных узлов;</span></li><li><span style="color: rgb(0,0,0);">если в кластер добавляются новые узлы или удаляются добавленные, обновите топологию с помощью скрипта `control.sh`.</span></li></ul><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Потеряосновных(primary)партицийпослеперезапускакластера" style=""><span style="color: rgb(0,0,0);">Потеря основных (primary) партиций после перезапуска кластера</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.23" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">После перезапуска кластера в log-файлах узлов появляется сообщение:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">[2022-03-09 15:30:43,662][WARN ]sys-#60%gridCommandHandlerTest0%[GridDhtPartitionTopologyImpl] Detected lost partitions [grp=default, parts=[3, 7, 13], topVer=AffinityTopologyVersion [topVer=6, minorTopVer=0]]
</pre>
</div></div><p><span style="color: rgb(0,0,0);"> <code class="language-text">
</code> </span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.24"><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Сообщения говорят о потере основных партиций после перезапуска кластера, но данные все еще можно загрузить с диска.</span></p><p style=""><span style="color: rgb(0,0,0);">Для решения проблемы выполните действия:</span></p><ol style=""><li><span style="color: rgb(0,0,0);">Запустите команду `<code>control.sh --cache reset_lost_partitions cacheName1,cacheName2,...`.</code></span></li><li>Запустите команду `<code>control.sh --cache idle_verify`</code><span style="color: rgb(0,0,0);">.</span></li></ol><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Расхождениепартиций"><span style="color: rgb(0,0,0);">Расхождение партиций</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.24"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="ce81681a-79c1-405b-83e3-a7d43e600c6c">Проблема</span></span></h4><p style=""><span style="color: rgb(0,0,0);">Косвенные симптомы: </span></p><ul style=""><li><span style="color: rgb(0,0,0);">данные периодически не находятся по ключу, находятся не те данные или данные отсутствуют;</span></li><li>запрос уходит на один узел и выполняется корректно, но при запросе на другой ничего не возвращает.</li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.25" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Расхождением партиций называется состояние, при котором содержимое резервной (backup) партиции отличается от содержимого соответствующей ей основной партиции. Такие расхождения можно зафиксировать по следующим атрибутам партиции:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">`counter` — счетчик изменения партиций;</span></li><li><span style="color: rgb(0,0,0);">размер — количество записей;</span></li><li><span style="color: rgb(0,0,0);">хеш-сумма — результат обработки хеш-функцией данных, которые находятся в партиции.</span></li></ul><p style=""><span style="color: rgb(0,0,0);">Расхождения в партициях могут возникать из-за дефектов при работе с транзакционными кешами или в результате аварийных остановок узлов.</span></p><p style=""><span style="color: rgb(0,0,0);">Если в партициях обнаружились расхождения, их нужно устранить, так как они могут привести к некорректному выполнению бизнес-логики.</span></p><p style=""><span style="color: rgb(0,0,0);">У проблемы есть следующие симптомы:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">значения метрик;</span></li><li><span style="color: rgb(0,0,0);">сообщения в log-файлах;</span></li><li><span style="color: rgb(0,0,0);">ошибки в отчете `<code>idle_verify`</code>.</span></li></ul><p style=""><span style="color: rgb(0,0,0);">В целях диагностики запустите утилиту `<code>idle-verify`</code> с помощью команды:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">--cache idle_verify [--dump] [--skip-zeros] [--check-crc] [--exclude-caches cacheName1,...,cacheNameN] [--cache-filter DEFAULT|SYSTEM|PERSISTENT|NOT_PERSISTENT|USER|ALL] [cacheName1,...,cacheNameN]</pre>
</div></div><p><span style="color: rgb(0,0,0);"> <code class="language-bash">
</code> </span></p><p style=""><span style="color: rgb(0,0,0);">Где:</span></p><ul style=""><li><p><span style="color: rgb(0,0,0);"><code>`--dump`</code><span> </span>— перенаправление вывода результата работы в файл по пути `<code>$IGNITE_HOME/work/`</code>, формат названия файла `<code>idle-dump-YYYY-MM-DDTHH24-MI-SS_sss.txt`.</code></span></p></li><li><p><span style="color: rgb(0,0,0);"><code>`--skip-zeros`</code><span> </span>— пропуск партиций, в которых нет записей.</span></p></li><li><p><span style="color: rgb(0,0,0);"><code>`--check-crc`</code><span> </span>— проверка CRC-страниц.</span></p></li><li><p><span style="color: rgb(0,0,0);"><code>`--exclude-caches cacheName1,...,cacheNameN`</code><span> </span>— исключение кешей, по которым не нужно искать расхождения.</span></p></li><li><p><span style="color: rgb(0,0,0);"><code>`--cache-filter DEFAULT|SYSTEM|PERSISTENT|NOT_PERSISTENT|USER|ALL`</code> — тип кешей, по которым нужно искать расхождения:</span></p><ul><li><span style="color: rgb(0,0,0);"><code>`DEFAULT`</code> — пользовательские кеши или все кеши, которые явно указаны;</span></li><li><span style="color: rgb(0,0,0);"><code>`SYSTEM`</code> — системные кеши;</span></li><li><span style="color: rgb(0,0,0);"><code>`PERSISTENT`</code><span> </span>— персистентные кеши;</span></li><li><span style="color: rgb(0,0,0);"><code>`NOT_PERSISTENT`</code><span> </span>— неперсистентные кеши;</span></li><li><span style="color: rgb(0,0,0);"><code>`USER`</code><span> </span>— пользовательские кеши (</span><span style="color: rgb(0,0,0);">все кеши, кроме системных);</span></li><li><span style="color: rgb(0,0,0);"><code>`ALL`</code><span> </span>— все кеши независимо от типа и места хранения их данных.</span></li></ul></li><li><p><span style="color: rgb(0,0,0);"><code>`cacheName1,...,cacheNameN`</code> — имена кешей, в которых нужно искать расхождения.</span></p></li></ul><p style=""><span style="color: rgb(0,0,0);">Утилита может отработать с двумя результатами:</span></p><ul style=""><li><p>Отсутствие расхождений:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">  The check procedure has finished, no conflicts have been found.</pre>
</div></div></li><li><p><span style="color: rgb(0,0,0);letter-spacing: 0.0px;">Наличие расхождений:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence"> idle_verify task was executed with the following args: caches=[], excluded=[], cacheFilter=[DEFAULT] # Аргументы, с которыми запущен idle_verify
idle_verify check has finished, found 3 conflict partitions: [counterConflicts=0, hashConflicts=148] # Количество конфликтов (в данном примере 3), с разбивкой по типам counterConflicts и hashConflicts.
Hash conflicts: # Все, что идет ниже, относится к расхождениям по хешу.

Conflict partition: PartitionKeyV2 [grpId=1095989593, grpName=card-stream-linker-service-cache-prom, partId=851] # Сообщение указывает на то, в какой партиции (partId=851) и какой кеш-группе (grpId=1095989593, grpName=card-stream-linker-service-cache-prom) выявлены расхождения
Partition instances: [
PartitionHashRecordV2 [isPrimary=false, consistentId=93dce233-c0b2-4b3c-8562-28d621a69954, updateCntr=20600, partitionState=OWNING, size=17, partHash=318600276],
PartitionHashRecordV2 [isPrimary=true, consistentId=158db893-e309-407e-9cb5-32d14ade1748, updateCntr=20600, partitionState=OWNING, size=16, partHash=-119291370]]

Conflict partition: PartitionKeyV2 [grpId=1095989593, grpName=card-stream-linker-service-cache-prom, partId=286]
Partition instances: [
PartitionHashRecordV2 [isPrimary=false, consistentId=93dce233-c0b2-4b3c-8562-28d621a69954, updateCntr=20541, partitionState=OWNING, size=22, partHash=623413003],
PartitionHashRecordV2 [isPrimary=true, consistentId=158db893-e309-407e-9cb5-32d14ade1748, updateCntr=20541, partitionState=OWNING, size=21, partHash=845648234],
PartitionHashRecordV2 [isPrimary=false, consistentId=e6775c04-5c1d-416c-831c-ff5b37d23985, updateCntr=20541, partitionState=OWNING, size=21, partHash=845648234]]

Conflict partition: PartitionKeyV2 [grpId=1095989593, grpName=card-stream-linker-service-cache-prom, partId=285]
Partition instances: [
PartitionHashRecordV2 [isPrimary=false, consistentId=93dce233-c0b2-4b3c-8562-28d621a69954, updateCntr=20599, partitionState=OWNING, size=25, partHash=481674619],
PartitionHashRecordV2 [isPrimary=false, consistentId=158db893-e309-407e-9cb5-32d14ade1748, updateCntr=20599, partitionState=OWNING, size=24, partHash=1206168917],
PartitionHashRecordV2 [isPrimary=true, consistentId=e6775c04-5c1d-416c-831c-ff5b37d23985, updateCntr=20599, partitionState=OWNING, size=24, partHash=1206168917]]
 </pre>
</div></div></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Полуавтоматическоевыравнивание">Полуавтоматическое выравнивание</h4><p><span style="color: rgb(0,0,0);">В качестве решения используйте механизм полуавтоматического выравнивания (Read repair</span><span style="color: rgb(0,0,0);">). Он позволяет контролируемо устранить расхождения партиций с применением разнообразных стратегий (`</span><code style="">LWW`</code><span style="color: rgb(0,0,0);">, `</span><code style="">PRIMARY`</code><span style="color: rgb(0,0,0);">, `</span><code style="">MAJORITY`</code><span style="color: rgb(0,0,0);">, `</span><code style="">REMOVE`</code><span style="color: rgb(0,0,0);">, `</span><code style="">REMOVE`</code><span style="color: rgb(0,0,0);">, `</span><code style="">CHECK_ONLY`). Подробнее о механизме написано в р</code><span style="color: rgb(0,0,0);">азделе [«Режим Read repair»](..<span class="">/</span>../developer-guide/md/read_repair_mode.md) документа «Руководство прикладного разработчика».</span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-НехваткаCPUприразвертываниинавиртуальныхмашинах" style=""><span style="color: rgb(0,0,0);">Нехватка CPU при развертывании на виртуальных машинах</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.25" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">Возможные проблемы:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">узлы выпадают с разными ошибками;</span></li><li>у метрики на `<code>Steal Time`</code><span style="color: rgb(0,0,0);"> ненулевое значение.</span></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.26" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Для виртуальных машин выделено недостаточно CPU. Эскалируйте проблему на сопровождение виртуальной инфраструктуры. </span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Заморозки(freeze)навиртуальныхмашинах" style=""><span style="color: rgb(0,0,0);">Заморозки (freeze) на виртуальных машинах</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.26" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">Возможные проблемы:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">Узлы выпадают по тайм-ауту.</span></li><li>В GC-логах присутствуют длительные GC-паузы. Содержимое GC-логов выглядит так, как будто мусор некоторое время не собирался.</li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.27" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Передайте проблему на анализ администраторам виртуальной инфраструктуры.</span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблемысхранениемданных"><span style="color: rgb(0,0,0);">Проблемы с хранением данных</span></h3><div class="table-wrap"><table class="wrapped confluenceTable"><thead class=""><tr class=""><th class="confluenceTh"><span style="color: rgb(0,0,0);">Симптом проблемы</span></th><th class="confluenceTh"><span style="color: rgb(0,0,0);">Возможная причина</span></th><th class="confluenceTh"><span style="color: rgb(0,0,0);">Решение</span></th></tr></thead><tbody class=""><tr class=""><td class="confluenceTd"><span style="color: rgb(0,0,0);">В Java возникает ошибка вида `</span><code style="">OutOfMemory Errors</code><span style="color: rgb(0,0,0);">`</span></td><td class="confluenceTd"><span style="color: rgb(0,0,0);">Недостаточный размер Java Heap или в</span><span style="color: rgb(0,0,0);">ыполнение объемных SQL-запросов</span></td><td class="confluenceTd"><ul style="text-align: left;"><li><span style="color: rgb(0,0,0);">Увеличьте<span> `</span><code>-Xmx` и `-Xms`.</code></span></li><li><span style="color: rgb(0,0,0);">Уменьшите<span> `</span></span>-XX:InitiatingHeapOccupancyPercent`. Данная опция указывает процент утилизации Java Heap, при котором следует начать параллельную сборку мусора (по умолчанию 45%). Более низкие значениям могут уменьшить среднюю утилизацию Heap.</li><li>Используйте ленивые (lazy) запросы — подробнее о них написано в [официальной документации Apache Ignite](<a class="external-link" href="attachments/performance-and-debugging" rel="nofollow">https://apacheignite-sql.readme.io/docs/performance-and-debugging#section-result-set-lazy-loading</a>).</li><li><span style="color: rgb(0,0,0);">Избегайте большого количества одновременных запросов.</span></li><li><span style="color: rgb(0,0,0);">Разделите SQL-запрос для снижения размера объема данных</span></li></ul></td></tr><tr class=""><td class="confluenceTd"><span style="color: rgb(23,43,77);">Генерируется</span><span style="color: rgb(0,0,0);"> исключение вида `<code>IgniteOutOfMemoryException`</code></span></td><td class="confluenceTd"><span style="color: rgb(0,0,0);">Недостаточный размер региона данных</span></td><td class="confluenceTd"><ul style=""><li><span style="color: rgb(0,0,0);">Увеличьте `<span>DataRegionConfiguration.maxSize</span>` — подробнее о нем написано в [официальной документации Apache Ignite</span><span style="color: rgb(0,0,0);">](<a class="external-link" href="attachments/capacity-planning" rel="nofollow">https://apacheignite.readme.io/docs/capacity-planning</a>).</span></li><li><span style="color: rgb(0,0,0);">Используйте<span> </span><span>Native Persistence</span></span> — подробнее о режиме написано в разделе [«Персистентность DataGrid»](..<span class="">/</span>../developer-guide/md/datagrid_persistence.md<span>) документа «Руководство прикладного разработчика».</span></li><li><span style="color: rgb(0,0,0);">Установите `<span>DataRegionConfiguration.pageEvictionMode=RANDOM_2_LRU</span>` —<span> </span></span>подробнее об алгоритме написано в разделе [«Политика вытеснения данных из кеша (Eviction Policies)»](..<span class="">/</span>../developer-guide/md/eviction_policies.md)<span> документа «Руководство прикладного разработчика».</span></li><li><span style="color: rgb(0,0,0);">Используйте<span> </span><span>политику истечения срока действия</span></span> — подробнее о ней написано в разделе [«Политика устаревания записей (Expiry Policy)»](..<span class="">/</span>../developer-guide/md/expiry_policy.md)<span> </span><span>документа «Руководство прикладного разработчика»</span></li></ul></td></tr><tr class=""><td class="confluenceTd"><p>Операционная система <span style="color: rgb(0,0,0);">останавливает Ignite JVM</span></p></td><td class="confluenceTd"><span style="color: rgb(0,0,0);">Суммарный размер процессов превысил RAM</span></td><td class="confluenceTd"><ol style=""><li><span style="color: rgb(0,0,0);">Проверьте наличие сообщения `</span><code style="text-align: left;">Out of memory: Kill process &lt;PID&gt; (java) score &lt;SCORE&gt; or sacrifice child`.</code></li><li><span style="color: rgb(0,0,0);">Убедитесь, что общий объем процессов находится в пределах объема доступной оперативной памяти.</span></li><li><span style="color: rgb(0,0,0);">Отключите<span> `</span></span><code style="text-align: left;">overcommit`</code><span style="color: rgb(0,0,0);">, чтобы получать более точные сообщения об ошибках в процессе.</span></li></ol><p style="">Важно:<span style="color: rgb(0,0,0);"> использование команды `<span>sysctl -w vm.overcommit_memory=2</span>`</span><span style="color: rgb(0,0,0);"> может повлиять на другие приложения. Подробнее о команде написано в [документации на сайте Linux Kernel](<a class="external-link" href="attachments/overcommit-accounting" rel="nofollow" style="">https://www.kernel.org/doc/Documentation/vm/overcommit-accounting</a>)</span></p></td></tr><tr class=""><td class="confluenceTd"><span style="color: rgb(0,0,0);">После перезапуска одного или нескольких узлов кластера происходит полная или частичная потеря данных. Динамику этих изменений можно увидеть на графике `</span><code style="text-align: left;">cache size`</code></td><td class="confluenceTd"><span style="color: rgb(0,0,0);">Отсутствие или нехватка резервных (backup) узлов для in-memory-кеша</span></td><td class="confluenceTd"><span style="color: rgb(0,0,0);">Если для in-memory-кеша отсутствует резервный (backup) узел, при перезапуске узла всегда будет происходить потеря данных. </span><span style="color: rgb(0,0,0);">Если в in-memory-кеше есть один или несколько резервных узлов, не рекомендуется одновременно перезапускать больше узлов, чем<span> </span></span><span style="color: rgb(23,43,77);">заданное в конфигурации количество backups для партиций. Дождитесь</span><span style="color: rgb(0,0,0);"> перезапуска после возвращения узла с помощью консоли</span></td></tr><tr class=""><td class="confluenceTd"><p><span style="color: rgb(0,0,0);">Возвращаются неправильные или неполные данные SQL</span></p></td><td class="confluenceTd"><p>П<span style="color: rgb(0,0,0);">роизошла коллокация данных</span></p></td><td class="confluenceTd"><span style="color: rgb(23,43,77);">Подробнее об этом написано в разделе </span><u style=""><span>[</span></u>«Работа с SQL и Apache Calcite»](..<span class="" style="color: rgb(23,43,77);">/</span>../developer-guide/md/working_with_sql_and_apache_calcite.md<span style="color: rgb(23,43,77);">)</span><span style="color: rgb(23,43,77);"> документа «Руководство прикладного разработчика»</span></td></tr><tr class=""><td class="confluenceTd"><span style="color: rgb(23,43,77);">П</span><span style="color: rgb(0,0,0);">роисходит потеря данных на некоторых узлах. Ошибку можно обнаружить в Persistence Storage по признакам:</span><br style="text-align: left;"/><span style="color: rgb(0,0,0);">- включен `<code>Native Persistence`</code>;</span><br style="text-align: left;"/><span style="color: rgb(0,0,0);">- данные хранятся только на одном узле или в подмножестве узлов;</span><br style="text-align: left;"/><span style="color: rgb(0,0,0);">- новые узлы не сохраняют данные</span></td><td class="confluenceTd"><span style="color: rgb(0,0,0);">Базовая топология не включает некоторые узлы</span></td><td class="confluenceTd"><span style="color: rgb(23,43,77);">И</span><span style="color: rgb(0,0,0);">змените состав топологии в `baseline` с помощью скрипта `control.sh` или Admin UI</span></td></tr></tbody></table></div><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-ИсчерпаниеJavaHeap" style=""><span style="color: rgb(0,0,0);">Исчерпание Java Heap</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.27" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">Падение с ошибкой `OutOfMemoryError`.</span></p><p style=""><span style="color: rgb(0,0,0);">&gt; <strong>Внимание</strong><br/>&gt;</span></p><p style=""><span style="color: rgb(0,0,0);">&gt; Утилизация heap, которая не приводит к `OutOfMemoryError`, не является проблемой. Триггеры по утилизации heap в мониторинге не приносят пользы.</span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.28" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Исчерпание heap может быть спровоцировано неверным планированием емкости кластера, когда реальная нагрузка и использование ресурса выше запланированных. Например, причиной могут быть большие транзакции SQL с сортировками или группировками, а также `putAll` и `getAll`.<span> </span>Таким запросам нужно временно сохранять результат выборки.</span></p><p style=""><span style="color: rgb(0,0,0);">Утечку памяти нужно устранить. Если проблема не вызвана утечками памяти:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">увеличьте объем heap на узлах — выставите опции `-xmx` и `-xms`;</span></li><li><span style="color: rgb(0,0,0);">увеличьте количество узлов.</span></li></ul><h2 id="id-Частовстречающиесяпроблемыипутиихустранения-ПроблемыприработеCDC"><span style="color: rgb(0,0,0);">Проблемы при работе CDC</span></h2><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-ДиагностикаиустранениесбоеввработеCDC"><span style="color: rgb(0,0,0);">Диагностика и устранение сбоев в работе CDC</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-ПричинынарушенийработыCDC"><span style="color: rgb(0,0,0);">Причины нарушений работы CDC</span></h4><p style=""><span style="color: rgb(0,0,0);">Нарушения в работе CDC могут вызывать следующие причины:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">особенности использования CDC;</span></li><li><span style="color: rgb(0,0,0);">ошибки конфигурации серверных узлов и приложений CDC;</span></li><li><span style="color: rgb(0,0,0);">инфраструктурные ошибки и ошибки со стороны окружения;</span></li><li><span style="color: rgb(0,0,0);">смена public API при обновлении.</span></li></ul><p style=""><span style="color: rgb(0,0,0);">Каждая из причин подробно описывается в разделах ниже.</span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-ОсобенностииспользованияCDC"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="d03ec46e-9000-4477-88be-c392abb37fab">Особенности использования CDC</span></span></h4><p style=""><span style="color: rgb(0,0,0);">Есть особенности в работе, которые стоит учитывать при настройке и эксплуатации, чтобы избежать ошибок в работе приложений CDC:</span></p><ul style=""><li><p><span style="color: rgb(0,0,0);">Нужно активировать кластеры-приемники, иначе появится ошибка:<br/></span></p><pre><span style="color: rgb(0,0,0);">```bash
<code class="language-text">Can not perform the operation because the cluster is inactive
</code>```</span></pre></li><li><p><span style="color: rgb(0,0,0);">Нужно создать кеши в обоих кластерах, иначе появится ошибка:<br/></span></p><pre><span style="color: rgb(0,0,0);">```bash
<code class="language-text">Cache with id not found [cacheId=1231231]
</code>``` </span></pre></li><li><p><span style="color: rgb(0,0,0);">В версиях DataGrid ниже 4.2130 до запуска CDC на всех кластерах нужно вставить какие-либо данные в реплицируемые кеши, чтобы зарегистрировать `binary metadata`. В противном случае появится ошибка:<br/></span></p><pre><span style="color: rgb(0,0,0);">```bash
<code class="language-text">BinaryObjectException: Cannot find metadata for object with compact footer
</code>``` </span></pre></li></ul><p style=""><span style="color: rgb(0,0,0);">Ошибки возникают при применении изменений и приводят к остановке:</span></p><ul style=""><li><span style="color: rgb(0,0,0);"><code>`ignite-cdc.sh`</code> — в случае прямой репликации между кластерами DataGrid;</span></li><li><span style="color: rgb(0,0,0);"><code>`kafka-to-ignite.sh`</code> — в случае репликации DataGrid через Kafka/Corax.</span></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Общийалгоритмдляанализапроблем,которыесвязанысCDC" style=""><span style="color: rgb(0,0,0);">Общий алгоритм для анализа проблем, которые связаны с CDC</span></h4><p style=""><span style="color: rgb(0,0,0);">Для анализа проблем, которые связаны с CDC, выполните действия:</span></p><ol style=""><li><span style="color: rgb(0,0,0);">Проверьте метрики и триггеры CDC в системе мониторинга. Убедитесь, что метрики по всем запущенным приложениям CDC увеличиваются на всех кластерах, если на них есть нагрузка.</span></li><li><span style="color: rgb(0,0,0);">В случае репликации через Kafka/Corax проверьте метрики `<code>log-end-offset`</code><span> </span>и `<code>lag`</code> в мониторинге Kafka/Corax.</span></li><li><span style="color: rgb(0,0,0);">Проанализируйте log-файлы серверного узла (`<code>ignite.log`</code>) и приложений CDC (`<code>ignite-cdc.log`</code><span> </span>и `<code>kafka-ignite-streamer.log`</code>) на предмет ошибок и предупреждений. Убедитесь, что данная проблема не относится к настройке DataGrid и плагина безопасности. Описание сообщений log-файлов при работе CDC есть в разделе [«Первичный анализ логов»]<u><span>(</span></u>..<span class="">/</span>../administration-guide/md/primary-analysis-of-logs.md</span><span>)</span> документа «Руководство по системному администрированию».</li><li><span style="color: rgb(0,0,0);">Если на кластер-источник есть нагрузка и приложения CDC завершают работу в течение нескольких минут после запуска, возможно появление проблем с настройкой приложений.</span></li><li><span style="color: rgb(0,0,0);">Если проблемы с CDC наблюдаются только при росте нагрузки на кластер-приемник, это может говорить о нехватке ресурсов для обработки событий репликации (медленная сеть или аппаратное обеспечение).</span></li><li><span style="color: rgb(0,0,0);">Спонтанные ошибки, например тайм-ауты отправки, могут говорить о проблемах с сетью или аппаратным обеспечением.</span></li></ol><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Ошибкиконфигурациисерверныхузлов"><span style="color: rgb(0,0,0);">Ошибки конфигурации серверных узлов</span></h4><p style=""><span style="color: rgb(0,0,0);">Для анализа данных ошибок проанализируйте log-файлы серверных узлов.</span></p><h5 id="id-Частовстречающиесяпроблемыипутиихустранения-Медленнаяротациясегментов" style=""><span style="color: rgb(0,0,0);">Медленная ротация сегментов</span></h5><p style=""><strong><span style="color: rgb(0,0,0);">Проблема:</span></strong></p><ul style=""><li><span style="color: rgb(0,0,0);">ступеньки в росте размеров кешей в системе мониторинга;</span></li><li><span style="color: rgb(0,0,0);">расхождение содержимого кешей и их размеров больше, чем ожидается (желтый график):</span></li></ul><p><span style="color: rgb(0,0,0);"> <span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img alt="" class="confluence-embedded-image" data-base-url="https://sberworks.ru/wiki" data-image-src="/wiki/download/attachments/317679769/image-2024-1-23_16-46-16.png?version=1&amp;modificationDate=1706458704501&amp;api=v2" data-linked-resource-container-id="317679769" data-linked-resource-container-version="67" data-linked-resource-content-type="image/png" data-linked-resource-default-alias="image-2024-1-23_16-46-16.png" data-linked-resource-id="317679767" data-linked-resource-type="attachment" data-linked-resource-version="1" data-unresolved-comment-count="0" draggable="false" height="250" src="attachments/image-2024-1-23_16-46-16.png"/></span> </span></p><p><span style="color: rgb(0,0,0);"> <strong><span class="inline-comment-marker" data-ref="fd05411d-8c3d-4917-96dd-16c6060abcc1">Решение:</span></strong><span class="inline-comment-marker" data-ref="fd05411d-8c3d-4917-96dd-16c6060abcc1"> </span></span></p><ol><li><p><span style="color: rgb(0,0,0);">В log-файлах серверных узлов проверьте частоту ротации WAL-сегментов:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">2022-12-15 05:35:35.768 [INFO ][grid-timeout-worker-#38][FileWriteAheadLogManager] Rollover segment [11324 to 11325], recordType=null
2022-12-15 06:54:46.798 [INFO ][grid-timeout-worker-#38][FileWriteAheadLogManager] Rollover segment [11325 to 11326], recordType=null</pre>
</div></div><p><br/></p><pre><span style="color: rgb(0,0,0);"> </span></pre><p><br/></p></li><li><p><span style="color: rgb(0,0,0);">Если ротация очень редкая (минуты или часы), проверьте в конфигурации наличие параметра `<code>walForceArchiveTimeout`</code>:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: xml; gutter: false; theme: Confluence" data-theme="Confluence"> &lt;bean class="org.apache.ignite.configuration.IgniteConfiguration"&gt;
&lt;property name="dataStorageConfiguration"&gt;
    &lt;bean class="org.apache.ignite.configuration.DataStorageConfiguration"&gt;
    &lt;property name="walForceArchiveTimeout" value="10000"/&gt;
... </pre>
</div></div></li></ol><h5 id="id-Частовстречающиесяпроблемыипутиихустранения-Невключеназаписьжурналанасерверномузле" style=""><span style="color: rgb(0,0,0);">Не включена запись журнала на серверном узле</span></h5><p style=""><span style="color: rgb(0,0,0);"><strong>Проблема</strong></span></p><p style=""><span style="color: rgb(0,0,0);">Не записывается журнал репликации, то есть в каталоге CDC не копятся сегменты и данные не реплицируются.</span></p><p style=""><span style="color: rgb(0,0,0);"><strong>Решение</strong></span></p><p style=""><span style="color: rgb(0,0,0);">Проверьте, установлен ли параметр `<code>cdcEnabled=true`</code> для регионов данных (`<code>DataRegion`</code>), в которых находятся реплицируемые кеши (не путайте с режимом кешей `<code>REPLICATED`</code>). Если параметр не установлен, жесткие ссылки не будут создаваться и изменения не будут реплицироваться в кластер-приемник.</span></p><h5 id="id-Частовстречающиесяпроблемыипутиихустранения-РазныеразделыWAL-архиваижурналарепликации" style=""><span style="color: rgb(0,0,0);">Разные разделы WAL-архива и журнала репликации</span></h5><p style=""><span style="color: rgb(0,0,0);">Сегменты, которые расположены в каталоге журнала репликации, являются жесткими ссылками на сегменты WAL-архива. Linux не поддерживает создание жестких ссылок на файлы, которые расположены в другом разделе файловой системы. Для решения проблемы разместите WAL-архив и журнал CDC в одном разделе файловой системы.</span></p><p style=""><span style="color: rgb(0,0,0);">В DataGrid версии 4.2130 и новее при запуске серверного узла появляется ошибка:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">     Paths are not stored at the same device or partition. Creating hard links is not available.</pre>
</div></div><p><span style="color: rgb(0,0,0);"> </span></p><p><span style="color: rgb(0,0,0);">В DataGrid версии 4.2120 во время ротации WAL-сегмента на серверном узле возникает другая ошибка:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence"> org.apache.ignite.internal.processors.cache.persistence.StorageException: Failed to archive WAL segment
...
Caused by: java.nio.file.FileSystemException: /opt/ignite/data/.../0000000000000000.wal -&gt;
/opt/ignite/wal_archive/.../0000000000000000.wal: Invalid cross-device link </pre>
</div></div><h5 id="id-Частовстречающиесяпроблемыипутиихустранения-НекорректныепараметрыConflictResolver"><span style="color: rgb(0,0,0);">Некорректные параметры ConflictResolver</span></h5><p style=""><span style="color: rgb(0,0,0);">&gt; <strong>Примечание</strong></span></p><p style=""><span style="color: rgb(0,0,0);">&gt;</span></p><p style=""><span style="color: rgb(0,0,0);">&gt; </span><span style="color: rgb(0,0,0);">Настройка плагина `ConflictResolver` описана в разделе [«Разрешение конфликтов репликации при помощи CacheVersionConflictResolver»]<u><span>(</span></u>..<span class="">/</span>../administration-guide/md/administration-scenarios.md</span><span>)</span> документа «Руководство по системному администрированию».</p><p style=""><span style="color: rgb(0,0,0);">Ошибки отображаются в серверных log-файлах, так как плагин `ConflictResolver` настраивается для серверных узлов.</span></p><h6 id="id-Частовстречающиесяпроблемыипутиихустранения-НенастроенConflictResolver" style=""><span style="color: rgb(0,0,0);">Не настроен ConflictResolver</span></h6><p style=""><span style="color: rgb(0,0,0);">Если не настроен `ConflictResolver` или в нем не указаны требуемые кеши, при изменении данных в обоих кластерах будут дублироваться и зацикливаться сообщения репликации.</span></p><p style=""><strong><span style="color: rgb(0,0,0);">Симптомы:</span></strong></p><ul style=""><li><span style="color: rgb(0,0,0);">хаотично меняются значения в кеше и постоянно применяются события репликации;</span></li><li><span style="color: rgb(0,0,0);">нагрузки на кластеры нет, но в log-файлах `<code>ignite-cdc.sh` и</code> `<code>kafka-to-ignite.sh`</code><span> </span>постоянно присутствуют сообщения `<code>Event received`</code>, `<code>Applying put batch`</code> или `<code>Applying remove batch`</code>;</span></li><li><span style="color: rgb(0,0,0);">CDC through Kafka: в topic событий растет `<code>log-end-offset`</code>, при определенной нагрузке может начать расти расхождение (lag);</span></li><li><span style="color: rgb(0,0,0);">в log-файлах серверного узла присутствуют сообщения о выполнении checkpoint и ротации WAL-сегментов (косвенный признак).</span></li></ul><p style=""><strong><span style="color: rgb(0,0,0);">Решение:</span></strong></p><ol style=""><li><span style="color: rgb(0,0,0);">Перезапустите все кластеры с корректной настройкой `ConflictResolver`. Если настроено поле `<code>conflictResolvableField`</code>, конфликты разрешатся автоматически.</span></li><li><span style="color: rgb(0,0,0);">Проверьте и восстановите согласованность между кластерами (подробнее об этом написано ниже в разделе [«Восстановление согласованности кластеров»](#восстановление-согласованности-кластеров)).</span></li></ol><h6 id="id-Частовстречающиесяпроблемыипутиихустранения-ОдинаковыйclusterId" style=""><span style="color: rgb(0,0,0);">Одинаковый clusterId</span></h6><p style=""><span style="color: rgb(0,0,0);">Основной симптом: с точки зрения разрешения конфликтов кластеры будут одинаковыми, поэтому произойдет безусловное применение событий репликации без сравнения значений `<code>conflictResolvableField`</code>. Две конкурентные вставки значения (`<code>INSERT`</code>) в разных кластерах применятся безусловно, это приведет к несогласованности.</span></p><p style=""><strong><span style="color: rgb(0,0,0);">Решение:</span></strong></p><ol style=""><li><span style="color: rgb(0,0,0);">Задайте разные `<code>clusterId`</code> в настройках кластеров.</span></li><li><span style="color: rgb(0,0,0);">Проверьте и восстановите согласованность между кластерами (подробнее об этом написано ниже в разделе [«Восстановление согласованности кластеров»](#восстановление-согласованности-кластеров)).</span></li><li><span style="color: rgb(0,0,0);">Устраните конфликты в прикладном коде или вручную.</span></li></ol><h6 id="id-Частовстречающиесяпроблемыипутиихустранения-НеуказанополеconflictResolveField"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="c6ad4394-cebd-4304-afc8-192c407a12e4">Не указано поле conflictResolveField</span></span></h6><p><span style="color: rgb(0,0,0);">Если не указать значение поля `<code>CacheVersionConflictResolverPluginProvider#conflictResolveField`</code>, конфликтные изменения (изменения одних и тех же записей в разных кластерах) не применятся, а в log-файлах серверных узлов появятся сообщения об ошибках вида:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">     [2023-05-23T18:03:12,756][ERROR][sys-stripe-13-#14][CacheVersionConflictResolverImpl] &lt;cache_name&gt; Conflict can't be resolved, update ignored [key=keyValue, fromCluster=1, toCluster=2]</pre>
</div></div><p style="text-align: left;"><strong><span style="color: rgb(0,0,0);">Решение:</span></strong></p><ol style="text-align: left;"><li><span style="color: rgb(0,0,0);">Задайте поле `<code>conflictResolveField`</code> в настройках серверных узлов.</span></li><li><span style="color: rgb(0,0,0);">Проверьте и восстановите согласованность между кластерами<span> </span><span>(подробнее об этом написано ниже в разделе [«Восстановление согласованности кластеров»](#восстановление-согласованности-кластеров)).</span></span></li></ol><h6 id="id-Частовстречающиесяпроблемыипутиихустранения-ОтсутствуетполеconflictResolveFieldвобъектах" style="text-align: left;"><span style="color: rgb(0,0,0);">Отсутствует поле conflictResolveField в объектах</span></h6><p style="text-align: left;"><span style="color: rgb(0,0,0);">Если в объектах не заданы значения полей, появится ошибка разрешения конфликта и записи в log-файле серверного узла вида:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence"> 2023-07-17T14:29:30,785 [ERROR][client-connector-#103%ignite-2029-server%][CacheVersionConflictResolverImpl] &lt;CacheName&gt; Error while resolving replication conflict. [field=modificationDate, key=org.examples.model.Key  [idHash=1992838831, hash=1745342858, keyId=2, stringId=ID2]]
java.lang.NullPointerException: null
    at org.apache.ignite.cdc.conflictresolve.CacheVersionConflictResolverImpl.isUseNew(CacheVersionConflictResolverImpl.java:128) ~[ignite-cdc-ext-14.1.0.jar:14.1.0]
 
...
 
2023-07-17T14:29:30,787 [ERROR][client-connector-#103%ignite-2029-server%][CacheVersionConflictResolverImpl] &lt;CacheName&gt; Conflict can't be resolved, update ignored [key=org.examples.model.Key  [idHash=1992838831, hash=1745342858, keyId=2, stringId=ID2], fromCluster=2, toCluster=1]</pre>
</div></div><p style=""><strong><span style="color: rgb(0,0,0);">Решение:</span></strong></p><ol style=""><li><span style="color: rgb(0,0,0);">Исправьте код приложения или сервиса, который осуществляет вставки в DataGrid — укажите монотонно возрастающее значение `<code>conflictResolveField`</code> во вставляемых объектах.</span></li><li><span style="color: rgb(0,0,0);">Проверьте и восстановите согласованность между кластерами<span> </span><span>(подробнее об этом написано ниже в разделе [«Восстановление согласованности кластеров»](#восстановление-согласованности-кластеров))</span>.</span></li></ol><h6 id="id-Частовстречающиесяпроблемыипутиихустранения-ЗначениеnullдляconflictResolveField" style=""><span style="color: rgb(0,0,0);">Значение null для conflictResolveField</span></h6><p style=""><span style="color: rgb(0,0,0);">Если в поле `<code style="text-align: left;">conflictResolveField`</code> задано значение `null`, появится ошибка разрешения конфликта и записи в log-файле серверного узла вида (стек-трейс может отличаться для разных типов полей):</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence"> 2023-07-17T14:06:51,025 [ERROR][client-connector-#105%ignite-2029-server%][CacheVersionConflictResolverImpl] &lt;CacheName&gt; Error while resolving replication conflict. [field=modificationDate, key=org.examples.model.Key  [idHash=420148468, hash=321295221, keyId=1, stringId=ID1]]
java.lang.NullPointerException: null
at java.sql.Timestamp.compareTo(Timestamp.java:515) ~[?:1.8.0_322]
at java.sql.Timestamp.compareTo(Timestamp.java:72) ~[?:1.8.0_322]
at org.apache.ignite.cdc.conflictresolve.CacheVersionConflictResolverImpl.isUseNew(CacheVersionConflictResolverImpl.java:128) ~[ignite-cdc-ext-14.1.0.jar:14.1.0]
...
 
2023-07-17T14:06:51,030 [ERROR][client-connector-#105%ignite-2029-server%][CacheVersionConflictResolverImpl] &lt;CacheName&gt; Conflict can't be resolved, update ignored [key=org.examples.model.Key  [idHash=420148468, hash=321295221, keyId=1, stringId=ID1], fromCluster=2, toCluster=1]</pre>
</div></div><p style=""><strong><span style="color: rgb(0,0,0);">Решение:</span></strong></p><ol style=""><li><span style="color: rgb(0,0,0);">Исправьте код приложения или сервиса, который осуществляет вставки в DataGrid — укажите монотонно возрастающее значение `<code>conflictResolveField`</code> во вставляемых объектах.</span></li><li><span style="color: rgb(0,0,0);">Проверьте и восстановите согласованность между кластерами<span> </span><span>(подробнее об этом написано ниже в разделе [«Восстановление согласованности кластеров»](#восстановление-согласованности-кластеров))</span>.</span></li></ol><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-ОшибкинастройкиприложенийCDC" style=""><span style="color: rgb(0,0,0);">Ошибки настройки приложений CDC</span></h4><h5 id="id-Частовстречающиесяпроблемыипутиихустранения-КлиентыDataGrid(тонкий,толстый)" style=""><span style="color: rgb(0,0,0);">Клиенты DataGrid (тонкий, толстый)</span></h5><p style=""><span style="color: rgb(0,0,0);">Все ошибки можно разделить на два основных типа:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">Ошибка плагина безопасности, аудита, параметров SSL или неверные имя пользователя и пароль.</span></li><li><span style="color: rgb(0,0,0);">Специфичные настройки DataGrid — неверный список адресов, неверные настройки клиентского узла Ignite и так далее. Например, перепутаны адреса кластеров или использованы сертификаты другого кластера.</span></li></ul><p style=""><span style="color: rgb(0,0,0);">Данные ошибки не относятся напрямую к CDC и должны решаться таким же образом, как и проблемы настройки клиентских узлов и тонких клиентов. При разборе следует учитывать:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">Для CDC Ignite2Ignite (прямая репликация между кластерам DataGrid) — клиент DataGrid запускается внутри приложения `<code>ignite-cdc.sh`</code><span> </span>на каждом серверном узле кластера-источника (source cluster).</span></li><li><span style="color: rgb(0,0,0);">Для CDC Ignite through Kafka (репликация через Kafka/Corax) — клиент Ignite запускается внутри приложения `<code>kafka-to-ignite.sh`</code>. Для работы достаточно одного клиента на каждый кластер-приемник.</span></li></ul><h5 id="id-Частовстречающиесяпроблемыипутиихустранения-НеверныйпутьккаталогужурналаCDC" style=""><span style="color: rgb(0,0,0);">Неверный путь к каталогу журнала CDC</span></h5><p style=""><span style="color: rgb(0,0,0);">Ошибка касается приложения `<code>ignite-cdc.sh`</code>. При настройке по умолчанию приложение запрашивает конфигурационный файл серверного узла. Возможные ошибки:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">при использовании отдельного конфигурационного файла-дубликата серверной конфигурации с отличающимися путями к журналу CDC;</span></li><li><span style="color: rgb(0,0,0);">если путь к каталогу может меняться динамически, например зависеть от JVM-опций `<code>CLUSTER_TYPE`</code><span> </span>и `<code>CLUSTER_NAME`</code>, когда эти опции отличаются для приложения CDC и серверного узла.</span></li></ul><h5 id="id-Частовстречающиесяпроблемыипутиихустранения-Неверныйсписоккешей" style=""><span style="color: rgb(0,0,0);">Неверный список кешей</span></h5><p style=""><span style="color: rgb(0,0,0);">При указании неверного списка кешей возможны ситуации:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">Реплицируются не все данные, если список неполный. К падению приложений это не приведет, но изменения в таком случае теряются. Можно решить проблему выгрузкой снепшота или данных через CDC (доступно в DataGrid версии 15.0 и новее). П<span>одробнее об этом написано ниже в разделе [«Восстановление согласованности кластеров»](#восстановление-согласованности-кластеров)</span>.</span></li><li><span style="color: rgb(0,0,0);">Приложение CDC завершает работу с ошибкой, так как кеш в кластере-приемнике не найден.</span></li></ul><h5 id="id-Частовстречающиесяпроблемыипутиихустранения-НекорректноеколичествопартицийKafka" style=""><span style="color: rgb(0,0,0);">Некорректное количество партиций Kafka</span></h5><p style=""><span style="color: rgb(0,0,0);">Если количество партиций в конфигурации меньше, чем в topic Kafka:</span></p><ul style=""><li><span style="color: rgb(0,0,0);"><code>`ignite-cdc.sh` —</code> ошибок в работе и потери данных не будет.</span></li><li><span style="color: rgb(0,0,0);"><code>`kafka-to-ignite` —</code><span> </span>если в настройках `<code>ignite-cdc.sh`</code><span> </span>указано верное количество партиций, `<code>kafka-to-ignite.sh`</code><span> </span>будет вычитывать события только из части партиций. Это приведет к потере событий при очистке по тайм-ауту устаревших записей из topics (из партиций Kafka/Corax, которые не вычитывались).</span></li></ul><p style=""><span style="color: rgb(0,0,0);">Если количество партиций в конфигурации больше, чем в topic Kafka:</span></p><ul style=""><li><p><span style="color: rgb(0,0,0);"><code>`ignite-cdc.sh` —</code><span> </span>завершит работу с ошибкой (по умолчанию через 60 секунд):</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">2022-11-07 13:08:17.537 [ERROR][Thread-18][] Cdc error
java.lang.RuntimeException: java.util.concurrent.ExecutionException: org.apache.kafka.common.errors.TimeoutException:
Topic TOPIC_NAME not present in metadata after 60000 ms.
    at org.apache.ignite.cdc.kafka.IgniteToKafkaCdcStreamer.onEvents(IgniteToKafkaCdcStreamer.java:183) ~[ignite-cdc-ext-2.12.0-p7.jar:2.12.0-p7]
    at org.apache.ignite.internal.cdc.WalRecordsConsumer.onRecords(WalRecordsConsumer.java:157) ~[ignite-core-2.12.0-p7.jar:2.12.0-p7]
    at org.apache.ignite.internal.cdc.CdcMain.consumeSegment(CdcMain.java:472) ~[ignite-core-2.12.0-p7.jar:2.12.0-p7]</pre>
</div></div></li><li><p><span style="color: rgb(0,0,0);"><code>`kafka-to-ignite.sh`</code>  — ошибок в работе и потери данных не будет, но `<code>KafkaConsumer`</code><span> </span>в приложении будет ожидать в течение `<code>kafkaRequestTimeout`</code><span> </span>при запросе данных из несуществующих партиций. Это может привести к росту расхождений в Kafka/Corax по части партиций и росту разницы размеров и состава кешей между кластерами (в системе мониторинга Grafana).</span></p></li></ul><h5 id="id-Частовстречающиесяпроблемыипутиихустранения-СлишкоммаленькоезначениеkafkaRequestTimeout(CDCthroughKafka)" style=""><span style="color: rgb(0,0,0);">Слишком маленькое значение kafkaRequestTimeout (CDC through Kafka)</span></h5><p style=""><span style="color: rgb(0,0,0);">Проблема — частое завершение работы `<code>ignite-cdc.sh`</code> и `<code>kafka-to-ignite.sh`</code> по тайм-ауту. Примеры ошибок находятся ниже в разделе [«Задержки при обмене сетевыми сообщениями»](#задержки-при-обмене-сетевыми-сообщениями).</span></p><p style=""><span style="color: rgb(0,0,0);">Для стабильной работы приложений `<code>ignite-cdc.sh`</code> и `<code>kafka-to-ignite.sh`</code> задавайте значение `<code>kafkaRequestTimeout`</code> в несколько раз больше `<code>request.timeout.ms`.</code> Это позволит клиенту Kafka/Corax совершить несколько повторных запросов.</span></p><p style=""><span style="color: rgb(0,0,0);">В текущих версиях DataGrid значение по умолчанию для `<code>kafkaRequestTimeout`</code> (3 секунды) меньше значения по умолчанию для `<code>request.timeout.ms` </code>(30 секунд).</span></p><h2 id="id-Частовстречающиесяпроблемыипутиихустранения-Нарушениясостороныокружения"><span style="color: rgb(0,0,0);">Нарушения со стороны окружения</span></h2><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-НевсепроцессыCDCзапущены"><span style="color: rgb(0,0,0);">Не все процессы CDC запущены</span></h3><p><span style="color: rgb(0,0,0);">Возможное поведение в случае, если не все процессы CDC запущены:</span></p><ul><li><p><span style="color: rgb(0,0,0);"><code>`ignite-cdc.sh`</code>:</span></p><ul><li><p><span style="color: rgb(0,0,0);">ни один процесс `<code>ignite-cdc.sh`</code> не запущен:</span></p><ul><li><span style="color: rgb(0,0,0);">Рост размеров реплицируемых кешей в кластере-приемнике прекратится, если на него нет нагрузки, или снизится, если нагрузка есть.</span></li><li><span style="color: rgb(0,0,0);">Репликация через Kafka/Corax: `<code>log-end-offset`</code><span> </span>в Kafka/Corax перестают расти по всем Kafka-партициям.</span></li><li><span style="color: rgb(0,0,0);">Прямая репликация DataGrid в DataGrid: наблюдается уменьшенное число подключений клиентов к кластеру-приемнику. `<code>ignite-cdc.sh`</code><span> </span>запускается на каждом серверном узле кластера-источника, поэтому количество клиентов в кластере-приемнике уменьшится на число серверных узлов кластера-источника. Если в настройках CDC используется толстый клиент, в log-файлах сервера будут выходы клиентов из топологии.</span></li></ul></li><li><p><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="2c0eb0fb-da9d-46c2-a569-f9a109339709">часть процессов `<code style="text-align: left;">ignite-cdc.sh`</code> не запущены:</span></span></p><ul><li><span style="color: rgb(0,0,0);">Рост размеров кешей в кластере-приемнике отстает от роста размеров кешей в кластере-источнике.</span></li><li><span style="color: rgb(0,0,0);">Репликация через Kafka/Corax: `<code>log-end-offset`</code><span> </span>в Kafka/Corax растут по части партиций быстрее, чем по другим Kafka-партициям.</span></li><li><span style="color: rgb(0,0,0);">Прямая репликация DataGrid в DataGrid: наблюдается уменьшенное количество подключений клиентов к кластеру-приемнику. Если в настройках CDC используется толстый клиент, в log-файлах серверного узла будут выходы клиентов из топологии.</span></li></ul></li></ul><p><span style="color: rgb(0,0,0);">На серверных узлах, где остановлены процессы `</span><code style="">ignite-cdc.sh`</code><span style="color: rgb(0,0,0);">, в каталоге CDC накапливаются WAL-сегменты.</span></p></li><li><p><span style="color: rgb(0,0,0);"><code><span class="inline-comment-marker" data-ref="4a3e908e-7b8a-4a27-ac68-b8d0e2f66af7">`kafka-to-ignite.sh`</span></code><span class="inline-comment-marker" data-ref="4a3e908e-7b8a-4a27-ac68-b8d0e2f66af7"> (только для варианта CDC через Kafka/Corax):</span></span></p><ul><li><span style="color: rgb(0,0,0);">Если все процессы `<code>kafka-to-ignite.sh`</code><span> </span>не запущены, `<code>lag`</code><span> </span>в Kafka/Corax растет равномерно по всем Kafka-партициям (при равномерной нагрузке на DataGrid). Рост размеров реплицируемых кешей в кластере-приемнике прекратится, если на него нет нагрузки, или снизится, если нагрузка есть.</span></li><li><span style="color: rgb(0,0,0);">Если часть процессов `<code>kafka-to-ignite.sh`</code><span> </span>не запущены, `<code>lag`</code><span> </span>в Kafka/Corax растет по части партиций быстрее, чем по другим Kafka-партициям (при равномерной нагрузке на DataGrid). Рост размеров кешей приемника отстает от роста размеров кешей в кластере-источнике.</span></li><li><span style="color: rgb(0,0,0);">Если разница между временем начала получения данных из Kafka/Corax и временем отправки сообщений из кластера-источника в Kafka/Corax превысит тайм-аут `<code>retention.time.ms`</code>, события репликации удалятся из Kafka.</span></li></ul></li></ul><p style=""><strong>Решение:</strong></p><ol style=""><li><span style="color: rgb(0,0,0);">Запустите процессы и проверьте, что они не завершают работу с ошибкой. Если появляются ошибки с остановкой процессов, проанализируйте и устраните их.</span></li><li><span style="color: rgb(0,0,0);">Убедитесь, что расхождение между кластерами уменьшается — размеры кешей приблизительно равны или их состав близок (если есть инструменты сверки).</span></li><li><span style="color: rgb(0,0,0);">Избегайте ситуаций, когда приложения `</span><code>ignite-cdc.sh`</code><span style="color: rgb(0,0,0);"><span> </span>запущены в кластере-источнике, а экземпляры `</span><code>kafka-to-ignite.sh`</code><span style="color: rgb(0,0,0);"><span> </span>длительное время не запущены в кластере-приемнике.</span></li></ol><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Постоянноерасхождениемеждукластерами"><span style="color: rgb(0,0,0);">Постоянное расхождение между кластерами</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.28" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">Расхождение между кластерами является постоянным и не сокращается. Если убрать нагрузку с кластера-источника, выравнивания размеров кешей не происходит. При этом все процессы продолжают работать корректно, журнал репликации не копится. В случае использования репликации через Kafka/Corax также видно, что расхождение близко к нулю.</span></p><p style=""><span style="color: rgb(0,0,0);">Такое состояние говорит о том, что данные потеряны по одной из причин:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">какое-то время была отключена запись CDC в кластере-источнике, при этом данные изменились;</span></li><li><span style="color: rgb(0,0,0);">была удалена часть WAL-сегментов в каталоге CDC;</span></li><li><span style="color: rgb(0,0,0);">данные потеряны в Kafka/Corax по истечении времени или переполнению места или удалены другим способом.</span></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.29" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">Проверьте и восстановите согласованность между кластерами. Подробнее об этом написано ниже в разделе [«Восстановление согласованности кластеров»](#восстановление-согласованности-кластеров).</span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Задержкиприобменесетевымисообщениями"><span style="color: rgb(0,0,0);">Задержки при обмене сетевыми сообщениями</span></h3><p><span style="color: rgb(0,0,0);">Возможные причины:</span></p><ul><li><span style="color: rgb(0,0,0);">нарушения сетевого обмена;</span></li><li><span style="color: rgb(0,0,0);">задержки обработки сообщений;</span></li><li><span style="color: rgb(0,0,0);">длительная недоступность кластера-приемника или Kafka/Corax, например из-за GC или неисправности оборудования</span><span style="color: rgb(0,0,0);">.</span></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-ПрямаярепликацияDataGrid"><span style="color: rgb(0,0,0);"> Прямая репликация DataGrid </span></h4><p><span style="color: rgb(0,0,0);">При ошибках и тайм-аутах обмена сообщениями между кластером-приемником и клиентом DataGrid последний ведет себя типичным для таких ситуаций образом. При первой ошибке применения событий в удаленный кластер приложение `</span><code style="">ignite-cdc.sh`</code><span style="color: rgb(0,0,0);"> завершит работу. Проведите анализ ошибок подключения толстого или тонкого клиента к кластеру.</span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-РепликациячерезKafka/Corax"><span style="color: rgb(0,0,0);"> Репликация через Kafka/Corax </span></h4><ul><li><p><span style="color: rgb(0,0,0);"><code>`ignite-cdc.sh`</code>:</span></p><ul style=""><li><p><span style="color: rgb(0,0,0);">Если обращение в Kafka/Corax происходит дольше, чем `</span><code style="text-align: left;">kafkaRequestTimeout`</code><span style="color: rgb(0,0,0);">, приложение завершает выполнение с ошибкой. Пример для тайм-аута 10 секунд:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">  Caused by: java.util.concurrent.TimeoutException: Timeout after waiting for 10000 ms.
    at org.apache.kafka.clients.producer.internals.FutureRecordMetadata.get(FutureRecordMetadata.java:78)
    at org.apache.kafka.clients.producer.internals.FutureRecordMetadata.get(FutureRecordMetadata.java:30)
    at org.apache.ignite.cdc.kafka.IgniteToKafkaCdcStreamer.sendOneBatch(IgniteToKafkaCdcStreamer.java:280)
    ... 14 more </pre>
</div></div><pre><span style="color: rgb(0,0,0);"> </span></pre></li><li><p><span style="color: rgb(0,0,0);">При прочих ошибках обращения к Kafka/Corax `<code>ignite-cdc.sh`</code><span> </span>также завершит работу. Для диагностики ошибок обмена обратитесь к документации Kafka/Corax.</span></p></li></ul></li><li><p><span style="color: rgb(0,0,0);"><code>`kafka-to-ignite.sh`</code>:</span></p><ul style="text-align: left;"><li><p><span style="color: rgb(0,0,0);">При ошибках и тайм-аутах обмена сообщениями между кластером-приемником и клиентом DataGrid последний ведет себя типичным для таких ситуаций образом. При первой ошибке применения событий в удаленный кластер `kafka-to-ignite.sh` завершит работу.</span></p></li><li><p><span style="color: rgb(0,0,0);">Если обращение в Kafka/Corax происходит дольше `<code>kafkaRequestTimeout`</code>, приложение `<code>kafka-to-ignite.sh`</code><span> </span>может завершить выполнение с одной из ошибок. Пример для тайм-аута 10 секунд:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence">[2023-05-23T17:14:11,512][ERROR][applier-thread-3][KafkaToIgniteCdcStreamerApplier] Applier error!
org.apache.kafka.common.errors.TimeoutException: Timeout of 10000ms expired before successfully committing the current consumed offsets

[2023-05-23T17:54:30,908][ERROR][applier-thread-1][KafkaToIgniteCdcStreamerApplier] Applier error!
org.apache.kafka.common.errors.TimeoutException: Failed to get offsets by times in 10013ms

[2023-05-23T17:58:01,155][ERROR][applier-thread-1][KafkaToIgniteCdcStreamerApplier] Applier error!
org.apache.kafka.common.errors.TimeoutException: Timeout of 10000ms expired before successfully committing the current consumed offsets

Failed to run app: Timeout expired while fetching topic metadata
class org.apache.ignite.IgniteException: Timeout expired while fetching topic metadata
at org.apache.ignite.cdc.kafka.AbstractKafkaToIgniteCdcStreamer.run(AbstractKafkaToIgniteCdcStreamer.java:127)
at org.apache.ignite.cdc.kafka.KafkaToIgniteCdcStreamer.run(KafkaToIgniteCdcStreamer.java:71)
at org.apache.ignite.cdc.kafka.KafkaToIgniteCommandLineStartup.main(KafkaToIgniteCommandLineStartup.java:68)</pre>
</div></div></li><li><p><span style="color: rgb(0,0,0);">При прочих ошибках обращения к Kafka/Corax `<code>kafka-to-ignite.sh`</code><span> </span>также завершит работу. Для анализа и устранения данных ошибок обратитесь к документации Kafka/Corax.</span></p></li></ul></li></ul><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Всезапущено,норасхождениемеждукластерамирастет"><span style="color: rgb(0,0,0);">Все запущено, но расхождение между кластерами растет</span></h4><p style=""><span style="color: rgb(0,0,0);">Если все процессы CDC запущены, увеличивающаяся задержка возможна в ситуации, когда вставка в кластер-приемник не успевает за отправкой сообщений из кластера-источника:</span></p><ul style=""><li><p><span style="color: rgb(0,0,0);">Прямая репликация DataGrid в DataGrid: скорость генерации WAL выше, чем скорость применения в удаленный кластер — медленный удаленный кластер или сеть. В каталоге CDC копятся сегменты.</span></p></li><li><p><span style="color: rgb(0,0,0);">Репликация через Kafka/Corax:</span></p><ul><li><span style="color: rgb(0,0,0);">Низкопроизводительный кластер Kafka/Corax.</span></li><li><span style="color: rgb(0,0,0);">Медленная запись в Kafka, быстрое чтение (`<code>lag`)</code><span> </span>в Kafka/Corax нулевое. В каталоге CDC копятся WAL-сегменты.</span></li><li><span style="color: rgb(0,0,0);">Медленный кластер-приемник — медленное чтение, `<code>lag`</code> в Kafka/Corax будет расти.</span></li></ul></li></ul><h5 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.30" style=""><span style="color: rgb(0,0,0);">Решение</span></h5><p style=""><span style="color: rgb(0,0,0);">Устраните проблемы с производительностью, в первую очередь — с сетью, серверами DataGrid и Kafka/Corax.</span></p><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-НехваткаместанадискеподWAL-архив"><span style="color: rgb(0,0,0);">Нехватка места на диске под WAL-архив</span></h3><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Проблема.29" style=""><span style="color: rgb(0,0,0);">Проблема</span></h4><p style=""><span style="color: rgb(0,0,0);">WAL-сегменты копятся из-за того, что их не обрабатывает приложение `<code>ignite-cdc.sh`</code>. Длительное накопление приводит к падению серверных узлов из-за переполнения места в разделе с WAL-архивом.</span></p><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.31" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><p style=""><span style="color: rgb(0,0,0);">В большинстве случаев проблема связана с тем, что не запущено приложение `<code>ignite-cdc.sh`:</code></span></p><ol style=""><li><span style="color: rgb(0,0,0);">Запустите процесс `<code>ignite-cdc.sh`</code>. </span></li><li><span style="color: rgb(0,0,0);">Убедитесь, что он продолжает работу, а количество сегментов перестало увеличиваться.</span></li></ol><p style=""><span style="color: rgb(0,0,0);">&gt; <strong>Примечание</strong><br/></span><span style="color: rgb(0,0,0);">&gt;<br/></span><span style="color: rgb(0,0,0);">&gt; </span><span style="color: rgb(0,0,0);">В версиях DataGrid до 14.1.2 при перестройке индексов в кластере без нагрузки происходит накопление сегментов, так как `</span><code>ignite-cdc.sh`</code><span style="color: rgb(0,0,0);"> не удаляет обработанные сегменты. В данном случае может потребоваться очистка каталога CDC.<br/>&gt;<br/></span><span style="color: rgb(0,0,0);letter-spacing: 0.0px;">&gt; Целевое решение — обновление DataGrid. Работы по перестройке рекомендуется планировать после обновления.</span></p><p style=""><span style="color: rgb(0,0,0);">Дополнительные рекомендации:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">Следите за местом на диске.</span></li><li>Увеличьте раздел под WAL-архив.</li><li>При длительном отключении реплики можно отключать запись журнала (`<code>cdcEnabled=false`</code><span style="color: rgb(0,0,0);"><span> </span>или с помощью скрипта `</span><code>control.sh`</code><span style="color: rgb(0,0,0);">). Нужно учитывать, что это приведет к потере изменений и может потребовать восстановления согласованности (подробнее об этом написано ниже в разделе [«Восстановление согласованности кластеров»](#восстановление-согласованности-кластеров))</span><span style="color: rgb(0,0,0);">.</span></li></ul><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-ПотеряWAL-сегментов"><span style="color: rgb(0,0,0);"><span class="inline-comment-marker" data-ref="d338015b-d2d3-4336-b52f-fa771603b695">Потеря WAL-сегментов</span></span></h3><p><span style="color: rgb(0,0,0);">При пропуске сегментов `</span><code style="">ignite-cdc.sh`</code><span style="color: rgb(0,0,0);"> завершает работу с ошибкой. В сообщении выведется индекс первого пропущенного WAL-сегмента:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Confluence" data-theme="Confluence"> 2023-07-17T21:40:29,250 [ERROR][Thread-1][] Cdc error
org.apache.ignite.IgniteException: Found segment greater then saved state. Some events are missed. Exiting! [state=IgniteBiTuple [val1=WALPointer [idx=2, fileOff=43303, len=0], val2=0], segment=8]
    at org.apache.ignite.internal.cdc.CdcMain.consumeSegment(CdcMain.java:488) ~[ignite-core-14.1.0.jar:14.1.0]</pre>
</div></div><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-Решение.32" style=""><span style="color: rgb(0,0,0);">Решение</span></h4><ol style=""><li><span style="color: rgb(0,0,0);">Выполните пропуск потерянных сегментов, чтобы приложение `<code>ignite-cdc.sh`</code><span> </span>смогло запуститься. Подробнее об этом написано в разделе [«Обработка пропущенных сегментов»]<u><span>(</span></u>..<span class="">/</span>../administration-guide/md/administration-scenarios.md</span><span>)</span><span> </span>документа «Руководство по системному администрированию».</li><li><span style="color: rgb(0,0,0);">Выполните выгрузку данных из кластера с потерянными сегментами. Подробнее об этом написано ниже в разделе [«Восстановление согласованности кластеров»](#восстановление-согласованности-кластеров).</span></li></ol><h4 id="id-Частовстречающиесяпроблемыипутиихустранения-НекорректныенастройкиброкеровKafka/Coraxиклиентов"><span style="color: rgb(0,0,0);">Некорректные настройки брокеров Kafka/Corax и клиентов</span></h4><p style=""><span style="color: rgb(0,0,0);">Учитывайте, что у клиентов и брокеров Kafka/Corax, которые запускаются в приложениях CDC, есть множество настроек, значительно влияющих на их поведение. Могут встречаться следующие ошибки:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">Превышение допустимого размера сообщений для topic — `<code>ignite-cdc.sh`</code><span> </span>завершит работу. Потребуется перенастройка topics (брокеров).</span></li><li><span style="color: rgb(0,0,0);">Установка `<code>auto.offset.reset=latest`</code> в настройках <code>kafka-to-ignite.sh`</code><span> </span>приведет к тому, что при перезапуске чтение событий будет начинаться не с самого раннего события (`<code>auto.offset.reset=earliest`</code>), а с последнего. Это приведет к потере изменений, которые были записаны в topics между моментами остановки и последующего запуска. В таком случае потребуется восстановление согласованности — подробнее об этом написано в следующем разделе.</span></li><li><span style="color: rgb(0,0,0);">Установка `<code>enable.auto.commit=true`</code><span> </span>может привести к ситуации, когда `<code>kafka-to-ignite.sh`</code><span> </span>не смог применить изменения, а смещение успешно применилось. В таком случае изменения, которые не применились, будут утеряны. В `<code>kafka-to-ignite.sh`</code><span> </span>используется ручное применение смещений только после успешного применения изменений, поэтому нужно устанавливать `<code>enable.auto.commit=false`.</code></span></li><li><span style="color: rgb(0,0,0);">Переполнение места в Kafka/Corax при большом потоке событий CDC. Решается повторным расчетом сайзинга Kafka.</span></li></ul><h3 id="id-Частовстречающиесяпроблемыипутиихустранения-Восстановлениесогласованностикластеров"><span style="color: rgb(0,0,0);">Восстановление согласованности кластеров</span></h3><p style=""><span style="color: rgb(0,0,0);">Определить расхождение согласованности можно косвенно по симптомам конкретной проблемы. Типичные проблемы описаны выше в разделе [«Диагностика и устранение сбоев в работе CDC»](#диагностика-и-устранение-сбоев-в-работе-cdc).</span></p><p style=""><span style="color: rgb(0,0,0);">Более точный способ — прикладная сверка. Она требует от пользователя DataGrid написания утилиты или сервиса, который сможет определить расхождения объектов на разных кластерах и предложить решения по устранению конфликтов с учетом бизнес-логики.</span></p><p style="">&gt; <strong>Внимание</strong><br/>&gt;<br/>&gt; <span style="color: rgb(0,0,0);">Описанная ниже функциональность работает в DataGrid версии 15.0 и новее.</span></p><p style=""><span style="color: rgb(0,0,0);">Для восстановления согласованности можно использовать выгрузку данных в CDC в следующих ситуациях:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">Если понятно, с какого кластера были отправлены некоторые изменения данных (был отключен CDC, очищен WAL CDC, Kafka/Corax и так далее). В таком случае нужно выгрузить данные из этого кластера в остальные.</span></li><li><span style="color: rgb(0,0,0);">Если какой-то кластер признан несогласованным и планируется его очистка или очистка некоторых кешей. Данные клонируются из других кластеров.</span></li></ul><p style=""><span style="color: rgb(0,0,0);">Для копирования данных из кластера выгрузите их в журнал CDC. Процедура описана в разделе [«Принудительная повторная отправка всех данных кеша в CDC»](..<span class="">/</span>../administration-guide/md/administration-scenarios.md<span style="color: rgb(23,43,77);">)</span> документа «Руководство по системному администрированию», при этом:</span></p><ul style=""><li><span style="color: rgb(0,0,0);">Команда выгрузит все текущие данные из указанных кешей в WAL CDC.</span></li><li><span style="color: rgb(0,0,0);">Данные скопируются в кластер-приемник с помощью приложений CDC.</span></li><li><span style="color: rgb(0,0,0);">Если в кешах-приемниках есть записи, при пересечении ключей произойдет обработка конфликтов (в соответствии с настройками плагина `ConflictResolver` в удаленном кластере). Удалений в кластере-приемнике не будет, поэтому в кеше-приемнике могут остаться старые данные. Если это нежелательное поведение, очистите кеши-приемники.</span></li></ul><p style=""><span style="color: rgb(0,0,0);">Клонирование кластера можно также использовать для развертывания нового кластера.</span></p><p><br/></p></main>
</body>
</html>